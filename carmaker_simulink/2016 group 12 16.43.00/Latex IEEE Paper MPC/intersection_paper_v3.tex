%\documentclass[journal]{IEEEtran}
\documentclass[letterpaper,10pt,conference]{ieeeconf}

\IEEEoverridecommandlockouts                              % This command is only
                                                          % needed if you want to
                                                          % use the \thanks command
\overrideIEEEmargins
% See the \addtolength command later in the file to balance the column lengths
% on the last page of the document

\usepackage{amsmath,amssymb}
\usepackage{graphicx}                    % For pdf, bitmapped graphics files
\usepackage[usenames,dvipsnames]{xcolor} % For font in color
\usepackage{eurosym}                     % For writing sybmol for euro
\usepackage{siunitx}                     % For writing SI units
%\usepackage{subfigure}                   % For subfigures
%\usepackage{multirow}                    % Span table cells on multiple rows
%\usepackage{balance}                     % For ballancing the last page

\usepackage[]{units}
\usepackage{comment}
% custom commands
\newcommand{\red}[1]{\textcolor{red}{#1}}  % we use red color for comments

%\author{Nikolce Murgovski, Gabriel Rodrigues de Campos, Jonas Sj\"oberg
%\thanks{The authors are with the Department of Signals and Systems, Chalmers University of Technology, Sweden. {\tt \{nikolce.murgovski, gabriel.campos, jonas.sjoberg\}@chalmers.se.}}%
%\thanks{G. R. Campos is also with the DEIB, Politecnico di Milano, Italy. {\tt gabriel.rodriguesdecampos@polimi.it}}%
%\thanks{The research leading to these results was supported by the grant AD14VARI02 - Progetto ERC BETTER CARS - Sottomisura B, the S2, SAFER, and by the European Commission Seventh Framework Programme under the project AdaptIVe, grant agreement number 610428.}% <-this % stops a space
%}
\author{Markus Carlander, Niklas Lidander, Lea Riegger, Nikolce Murgovski, Jonas Sj\"oberg}
%\thanks{The authors are with the Department of Signals and Systems, Chalmers University of Technology, Sweden. {\tt \{nikolce.murgovski, gabriel.campos, jonas.sjoberg\}@chalmers.se.}}%
%\thanks{G. R. Campos is also with the DEIB, Politecnico di Milano, Italy. {\tt gabriel.rodriguesdecampos@polimi.it}}%
%\thanks{The research leading to these results was supported by the grant AD14VARI02 - Progetto ERC BETTER CARS - Sottomisura B, the S2, SAFER, and by the European Commission Seventh Framework Programme under the project AdaptIVe, grant agreement number 610428.}% <-this % stops a space
%}

\newlength \figwidth
\setlength \figwidth {\columnwidth}


\graphicspath{{figures/}}

\begin{document}
\title{Centralized MPC for autonomous intersection crossing}

\maketitle
\thispagestyle{empty}
\pagestyle{empty}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{abstract}
This paper proposes a method for a safe and autonomous intersection crossing. A centralized system controls autonomous vehicles within a certain surrounding of the intersection and generates optimized trajectories for all vehicles in the area. By formulating a convex quadratic optimization problem in space domain with respect to collision avoidance constraints, a model predictive controller is designed. To validate the controller for a more advanced vehicle model, a complete simulation environment for virtual test driving is generated by combining CarMaker with Matlab/Simulink. A case study shows the effectiveness of the proposed method.
\end{abstract}

\IEEEpeerreviewmaketitle

\section{Introduction}%from the planning report, we have to change that a bit

Around the world, traffic accidents that are related to intersections occur all too often. Compiled statistic from several European Countries shows that \SI{43}{\%} of all road injury accidents can be related to intersections \cite{molinero}. Statistic conducted in the USA indicates similar numbers \cite{nhtsa}. The actual number of related traffic accidents in Sweden is slightly less in total. Of all reported accidents in the year 2014 in Sweden, \SI{24}{\%} are intersection related. Of those, \SI{91}{\%} led to severe person injuries \cite{sverige}. As the statistics show, intersections lead to high risk for accidents. Even though the most dangerous intersections are regulated by traffic lights, signs and road-markings, accidents occur still very frequently. Higher safety in intersection crossing comes at a price in today's society since it limits the traffic flow. This causes bottlenecks in the traffic rhythm which not only wastes a lot of time for travelers but also leads to environment pollution caused by unnecessary accelerations and decelerations.

Today's vehicles are trending to become more and more autonomous. Exclusive benefits as adaptive cruise control, automatic lane change maneuvers, parking assistance are available on the market today. Statistics from USA show that about \SI{96}{\%} of all intersection related accidents are attributed to drivers \cite{nhtsa}. If intersections would be controlled by an autonomous cooperative intersection algorithm that can optimize the crossing sequence for all nearby vehicles, the intersection should be more safe since no human factor would cause accidents. The intersection should also be more efficient in both terms, time and energy consumption, since the algorithm would decide the crossing order and vehicles' speed for maximum efficiency. Aspects as minimizing deceleration, respectively acceleration, as well as reducing the total time for the intersection crossing could be taken into account for computing the optimal crossing sequence. It would also be possible to set different priority orders for different types of vehicles, for example according to their fuel consumption and performance. Emergency vehicles could be given precedence to enter the intersection on call-out.

In this paper, a Model Predictive Controller (MPC) is designed for a centralized system which takes control over autonomous vehicles within a certain surrounding of the intersection. The vehicles are assumed to drive fully autonomously. Among other recent work some have already exploited the idea of using different MPC implementations \cite{eleven}, \cite{twelve}, \cite{thirteen}, \cite{fourteen}, \cite{fifteen}, \cite{nikolce}. In \cite{thirteen} for example, the solution is approximated by a centralized, finite time optimal control problem. In \cite{fourteen}, a decentralized approach based on sub-optimal decision-making heuristics is used.

The general optimization algorithm for intersection crossing in this paper is based on the modeling approach of \cite{nikolce} where the problem is formulated in space coordinates and inverse of speed is used as a state variable. For a given crossing sequence, the approach allows the problem to be formulated as a convex program that optimizes vehicles' speed and prevents collisions. This paper has two main contributions. First, an MPC is designed with the convex modeling proposed by \cite{nikolce}. The MPC generates optimized trajectories for all vehicles in the controlled area, such that a cost function is minimized and several constraints are satisfied. The vehicles may differ in speed, acceleration and braking capabilities. Second, this paper implements the MPC in Matlab/Simulink and the simulation tool CarMaker, which provides advanced vehcile models making the simulation more realistic.
%Even though the design of the MPC controller is a highlighted area, the focus of this article is on the implementation and simulation using CarMaker.

The paper is organized as follows: Section \ref{sec:problem_formulation} gives an overview of the convex problem formulation in space coordinates. In Section \ref{sec:MPC} an MPC is designed. Section \ref{sec:simulation} provides an MPC simulation in CarMaker running under Matlab/Simulink. Section \ref{sec:casestudy} shows a case study and investigates the controller efficiency in the simulation environment. Section \ref{sec:conclusions} closes the paper with final conclusions.

\section{Problem Formulation} \label{sec:problem_formulation}
This section presents the modeling approach proposed by \cite{nikolce} and formulates the autonomous intersection crossing as a convex optimization problem.

\subsection{Assumptions}
Considering $N_v$ autonomous vehicles in a surrounding of an intersection, each with a predefined path which they are assumed to follow, it is assumed that for each vehicle $i=1,...N_v$, the acceleration along its path can be varied. The vehicle dynamics in the control model are simplified to a point mass model.

The presented intersection crossing scenario is limited to one vehicle per lane which means that the scenario where vehicles are following each other on the same lane is not studied. Nevertheless, the controller is designed so that an adaptation to enable this is possible.

\subsection{Problem statement}

An illustration of an intersection is shown in Fig. \ref{fig:Int}. The red color indicates the critical set, the yellow color indicates the soft set and the light blue color indicate the start and end of the control region. The position where vehicle $k$ enters and exits the critical set is called $L_k$ and $H_k$ respectively. The order of which vehicles crosses the intersection is called a crossing sequence and the matrix which contains all the possible crossing sequences is called permutation matrix  $\Omega$.

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.9\columnwidth]{czone.pdf}
    \caption{Illustration of an intersection showing the critical zone, soft and and control region.}
    \label{fig:Int}
\end{figure}

\subsection{Convex problem statement}
To formulate the optimization problem in a convex form, it is formulated in space coordinates, rather than time, according to \cite{nikolce}. With the spatial coordinate $p$, the linear state space model
\begin{align}\label{statesp}
\begin{split}
\kappa_i'(p)&=\underbrace{\begin{pmatrix}
0& 1\\
0& 0
\end{pmatrix}}_{{A}}\kappa_i(p) + \underbrace{\begin{pmatrix}
0\\
1\end{pmatrix}}_Bu_i(p)
\end{split}
\end{align}
is used to model each vehicle $i$, where $\kappa_i=\begin{pmatrix}t_i(p)& z_i(p)\end{pmatrix}^T$ is the state vector and $\kappa_i'=d\kappa/dp$ is the derivative with respect to the spatial distance $p$. The \emph{lethargy} \mbox{$z_i(p)=1/v_i(p)$} indicates the slowness of the system and $t_i(p)$ is the time needed to reach position $p$. Input $u_i(p)=z_i'(p)$ is the spatial derivative of $z_i(p)$.

\subsubsection{Cost function}
The cumulative cost function is the sum of cost functions for each vehicle $i$
\begin{align}
\min_{u_i(p)} \sum_{i=1}^{N_v}
J_i(\kappa_i(p), u_i(p), u_i'(p), \kappa_i(p_{if}))\, \label{costspace}
\end{align}
where $p_{if}$ is the final position after leaving the intersection. The convex cost function for each vehicle $i$ is
\begin{equation}\label{eq:costfnc}
J_i = J_{i1}+J_{i2}+J_{i3}.
\end{equation}
The first terms
\begin{subequations}
\begin{equation}
J_{i1} = w_{i1}\bar{v}_{ir}^3 \int_0^{p_{if}}\left(z_i(p)-\frac{1}{v_{ir}(p)}\right)^2 dp
\label{cost1}
\end{equation}
penalize the deviation from the reference velocity, where $w_{ij}$ [$j=1$ in \eqref{cost1}] are weighting factors. The mean of the reference velocity $v_{ir}(p)$ for each car $i$ is $\bar{v}_{ir}$. The term $J_{i2}+J_{i3}$ with
\begin{align}
J_{i2} = w_{i2}\bar{v}^5_{ir}
\int_0^{p_{if}}u^2_i(p) dp, \\
J_{i3} = w_{i3}\bar{v}_{ir}^7\int_0^{p_{if}}u_i'^2(p) dp
\end{align}
\end{subequations}
penalizes high longitudinal acceleration and jerk to guarantee a comfortable drive and limited actuator usage. The unconventially appearence of J_{i2} and J_{i3} with powers of the mean velocity is due to that the problem is described in space coordinates. In \cite{nikolce} it is shown how these are obtained from quadratic penalties in the time domain.

\subsubsection{Constraints}
In addition to the equality constraint (\ref{statesp}), the problem includes inequality constraints on the states $\kappa_i$ and the input $u_i$ as well as initial and final state constraints
\begin{subequations}\label{eq:constraints}
\begin{align}
\kappa_i'(p) &= A\kappa_i(p) + Bu_i(p)\label{eq:spm}\\
\kappa_i(p) &\in [\kappa_{imin}(p), \kappa_{imax}(p)]\label{eq:vlim}\\
%ignore u constraint first????
u_i(p) &\in [u_{imin}(p, z_i(p)), u_{imax}(p, z_i(p))]\label{eq:ulim}\\
\kappa_{i}(0)&=\kappa_{i0} = \begin{pmatrix}0& 1/v_{i0}\end{pmatrix}^T\\
\kappa_{i}(p_{if})&=\kappa_{if} = \begin{pmatrix}\mathrm{free}& 1/v_{if} \end{pmatrix}^T\label{eq:free},
\end{align}
where the limits \eqref{eq:ulim} are linear functions of $z_i$ and represent a linearized inner approximation of constant acceleration limits \cite{nikolce}. To avoid collisions, a final constraint is needed, which guarantees that a vehicle can enter a certain critical set at the center of the intersection, only when the previous vehicle has left the critical set, i.e.
\begin{align}
\begin{split}
t_k(H_k) \leq t_l(L_l),\; k&=\Omega_{m,n},\; l=\Omega_{m,n+1}\label{eq:col},\\
n&=1,\dots, N_v-1,
\end{split}
\end{align}
\end{subequations}
where $k$ and $l$ are indices of consecutive vehicles in a given crossing sequence $m$ of the permutation matrix $\Omega$, which contains all possible crossing sequences. Position $H_k$ is the point when vehicle $k$ exits the critical set and $L_l$ is the entry point for vehicle $l$.
For a given crossing sequence, the optimization problem is a convex quadratic program (QP).

More detailed explanations about the convex modeling of the problem can be found in \cite{nikolce}.
\section{MPC Design} \label{sec:MPC}
This section presents the optimization problem in a discrete space coordinate, proposes and extended cost function and rewrites the problem as a standard QP suitable for MPC implementation.
\subsection{Discrete state space model}
In order to implement the controller in Matlab, a discrete version of the model \eqref{statesp} with a sampling interval of $\unit[1]{m}$  is derived. The result is the following discrete state space representation
\begin{align}
\label{eq:model}
\begin{split}
\kappa_i(p+1) &= A \kappa_i(p) + B u_i(p).
\end{split}
\end{align}
%where $\kappa_i(p) = \begin{pmatrix}
%t_i(p) \\
%z_i(p)
%\end{pmatrix}$ and $u = z'_i$ for each vehicle %$i$ respectively.
\subsection{Extended cost function}
The constrain 5f prevents the vehicles to collide, but it aloud the vehicles to come very close to one another. If that happens, this can lead to that there is no feasible solution in a later sampling instant since there is no margin left. Hence, 5f need to be modified so that there is some margin between the vehicles. This is done by introducing slack variables. The constraint is modeled by adding a slack variable $s_j$ for each consecutive vehicle pair inside the control region. The variable $s_j$ expresses the time difference between the first vehicle leaving the intersection and the second vehicle entering the intersection. By predefining a suitable time difference $\Delta t$, the cost function \eqref{costspace} can be extended to
\begin{subequations}\label{slackall}
\begin{align}\label{eq:smin}
\min_{u_i, s_j} \sum_{i=1}^{N_v}J_i(\cdot) + \sum_{j=1}^{N_v-1}  &w_{j}\max (0,\Delta t -  s_j)^2
\end{align}
and the constraint \eqref{eq:col} can be replaced by
\begin{align}
\label{eq:saeq}
& s_j = t_l(L_l) - t_k(H_k), \quad s_j \geq 0.
\end{align}
\end{subequations}
The maximization in \eqref{eq:smin} is a convex function of $s_j$ and $\Delta t$, where $t_l(L_l)-t_k(H_k) < \Delta t$. Vehicle pairs in which the vehicles are far apart are not forced to have a predefined time difference in the crossing. The extended cost function \eqref{eq:smin} together with constraint \eqref{eq:saeq} effectively introduces an additional enlarged region, which is illustrated in Fig.~\ref{fig:CarM}. In comparison to the critical region, multiple vehicles may reside within the enlarged region, as long as they are outside the critical region.

Further, the min/max function in \eqref{eq:smin} can be written without the max term as
\begin{subequations}\label{qdef}
\begin{align}\label{eq:qmin}
\min_{s_j}\;  &\sum_{j=1}  w_{j} q_j^2\\
\text{subject to: } & q_j \geq \Delta t - s_j, \quad q_j \geq 0
\end{align}
\end{subequations}
where $q_j$ are additional optimization variables.
\subsection{Transformation to a standard QP}
In this section, the problem is transformed into the standard QP form
\begin{subequations} \label{stform}
\begin{align}\label{eq:quad}
\min_{x}\; &\frac{1}{2}x^THx+f^Tx\\
\text{subject to: }
&A_{eq}x =b_{eq},\label{eq:aeq}\\
&A_{in}x \leq b_{in}.\label{eq:ain}
\end{align}
\end{subequations}
where $x$ is the vector of optimization variables, $H$ the Hessian matrix and $f$ the remaining linear terms in the objective. The constraints are also transformed to fit the formulation in \eqref{eq:aeq}-\eqref{eq:ain}.
\subsubsection{Cost function}
The cost function \eqref{eq:costfnc} is transformed in a quadratic form for the MPC by writing the $x=\begin{pmatrix}x_1&\dots&x_{N_v}  \end{pmatrix}^T$ vector in \eqref{eq:quad} as


\begin{equation}
x_i=\begin{pmatrix}
K_i \\ U_i\\ U_i' \\ S_j \\ Q_j
\end{pmatrix}
\end{equation}

where $K_i=[\kappa_i(1),\ldots,\kappa_i(N)]^T$, $U_i=[u_i(0),\ldots,u_i(N-1)]^T$, $U'_i=[u'_i(0),\ldots,u'_i(N-1)]^T$, $S_j=[s_j(1),\ldots,s_j(N)]^T$, $Q_j=[q_j(1),\ldots,q_j(N)]^T$ for each vehicle $i$ and vehicle pair $j$ in the control region. 
The vector $x_i$ involves the states, the control input, the derivative of the control input and the slack variable. The prediction and control horizon are both equal to N. The Hessian matrix $H_i$ for each vehicle $i$ results in
\begin{equation}\label{eq:hessian}
H_i = 2
\begin{pmatrix}
    Q_{i1} & 0 & 0 & 0 & 0 \\
    0 & Q_{i2} & 0 & 0 & 0 \\
    0 & 0 & Q_{i3} & 0 & 0 \\
    0 & 0 & 0 & 0 & 0  \\
    0 & 0 & 0 & 0 & Q_{i4} 
\end{pmatrix},
\end{equation}
where the matrices $Q_{i1}, Q_{i2}$, $Q_{i3}$ and the scalar $Q_{i4}$ are equal to
\begin{subequations}
\begin{align}
Q_{i1} &= w_{i1}\bar{v}_{ir}^3 C^TC I_N, \\ 
Q_{i2} &=  w_{i2}\bar{v}_{ir}^5I_N ,\\
Q_{i3} &= w_{i3}\bar{v}_{ir}^7I_N, \\
Q_{i4} &= w_j,
\end{align}
\end{subequations}
where $I_N$ is the identity matrix with $N$ rows and $C=[0 \;\; 1]$.
The $f_i$ vector containing the remaining non-quadratic terms for each vehicle $i$ is
\begin{equation}
f_i^T = -2w_{i1}\bar{v}_{ir}^3\frac{1}{v_{ir}(p)}C
\begin{pmatrix}
1 & \hdots & 1 & 0 & \hdots & 0
\end{pmatrix}\label{eq:fvec}.
\end{equation}

%missing: definitions of w, v_ir etc.
\subsubsection{Constraints}
%The state constraint of the model in \eqref{eq:spm} can be written in the new equality constraint formulation \eqref{eq:aeq} as
The state constraint of the model described in \eqref{eq:spm} has to be reformulated in a matrix form as shown in \eqref{eq:aeq} with the discrete model described in \eqref{eq:model}. Furthermore, the constraints \eqref{eq:vlim}-\eqref{eq:ulim} limiting the state variables and the acceleration as well as the collision avoidance constraint \eqref{eq:col} can be written into new inequality constraints \eqref{eq:ain}. The two constraints \eqref{eq:vlim}-\eqref{eq:ulim} have to be split up into two constraints in order to be implemented in a matrix form.

In order to control $N_v$ vehicles, the cost function \eqref{eq:quad} needs to be extended. The new $x$ vector and Hessian matrix for $N_v$ cars are then according to \eqref{eq:quad}

\begin{align}
x &=\begin{pmatrix}
x_{1:N_v}^T 
\end{pmatrix}^T,\label{xvec}\\
H &= diag\begin{pmatrix}H_{1:N_v}\end{pmatrix},
\end{align}
and the $f$ vector is changed to the following

\begin{equation}
f^T = 
\begin{pmatrix}
f^T_{1:N_v}
\end{pmatrix}.
\end{equation}

Analogeus, the constraints also change in the same manner. Using the $x$ vector \eqref{xvec}, the equality and inequality constraints for all $N_v$ vehicles can be written as

\begin{align}
A_{eq}^T&=
\begin{pmatrix}
    A_{eq,1:N_v}^T
    \end{pmatrix},\\
    b_{eq}^T&=\begin{pmatrix}
    b_{eq,1:N_v}^T
    \end{pmatrix}, \\
A_{in}^T&=
\begin{pmatrix}
    A_{in,1:N_v}^T
    \end{pmatrix},\\
    b_{in}^T&=\begin{pmatrix}
    b_{in,1:N_v}^T
    \end{pmatrix}.
\end{align}
\subsection{Control area and optimization horizon}
Whether a vehicle is included in the MPC computation depends on its distance to the intersection. The control area of the centralized controller is defined for a certain surrounding of the intersection. Before entering the control area, it is assumed that the car drives with its reference speed. The control area is re-scanned in every time step searching for new arriving or leaving cars. The controller re-optimizes in every time step and takes therefore only the vehicles in the control area into account. The re-optimization is needed because the vehicles do not follow exactly the desired acceleration computed by the controller due to the simplified point mass model for the vehicle dynamics in the controller.\\ \indent
%Another important point is that the acceleration limits in space domain are convexified in \cite{nikolce} by linearizing $z^3_i(p)$ around the reference speed. Re-linearizing around the actual optimal velocity trajectory, as done in \eqref{ineq}, decreases the linearization error. This is another reason for the re-optimization.\\\\ \indent
Since there is no point in controlling the vehicles after they have passed the control radius, the optimization horizon $N$ is not moving along the vehicles as they advance. Instead the horizon is fixed to the end of the control radius. In this way, the optimization horizon is shrinking as the cars are progressing through the control area. This lowers the computation time of the MPC algorithm in each position step of the vehicles in the control area.
\section{Simulation} \label{sec:simulation}
\begin{figure*}[]
    \centering
    \includegraphics[width=1.8\columnwidth]{CarMaker_Implement2.png}
    \caption{Implementation of the MPC in Simulink combined with CarMaker's Simulink environment.}
    \label{fig:CM_Implement}
\end{figure*}
The designed MPC controller is based on a simple point mass model. In this section the controller is validated using an advanced vehicle model using CarMaker.\\ \indent
For the simulation, a combination of Matlab/Simulink and CarMaker is used. In this section, the focus is on connecting the MPC developed in Matlab/Simulink to a traffic and vehicle model created with CarMaker. The MPC is implemented as a Matlab Function block in Simulink, see Fig. \ref{fig:CM_Implement}. The simulation tool IPG CarMaker serves as a simulation environment to design a traffic model, containing an intersection and traffic flow. A detailed vehicle model is also provided by CarMaker. The detailed model is used in simulation to test if collisions are avoided. It is also possible in CarMaker to change the type or only some parameters of a car. Furthermore, CarMaker provides a video animation by the plug in program IPG Movie for visualizing the simulation results. This simplifies the validation and representation of the simulation results.
\subsection{Restrictions of CarMaker}
\subsubsection{CarMaker for Simulink}
The simulation speed for running CarMaker in Simulink is very slow, especially with additional models. Even little add-ons to the generic vehicle model can lead huge loss in computational performance \cite{qsguide}. Simulations with the MPC Matlab function block included are therefore very time consuming.
\subsubsection{Vehicle models}
A significant drawback of using CarMaker as a simulation environment in this case, is that CarMaker provides only one host car simulated as an advanced car model. It is not possible to control several vehicles with detailed vehicle dynamics. Except of the host car, all other cars can only be modeled as traffic objects, which implies static objects without dynamics. They are simulated as 3-D boxes with a certain initial position and acceleration. The acceleration of each traffic object can be overwritten with the output of the MPC, but it should be noted that these cars have the same dynamics as the point mass model used for the controller design.
\subsubsection{Road model}
A CarMaker road is constructed from start to stop by a list of road segments, each one only connected with the previous and following segment \cite{guide}. Thus, it is difficult to construct an intersection, because it is a multiple choice path. For simplicity, an intersection can be constructed by making a turn and letting the road cross itself (see Fig. \ref{fig:CarM}). This causes a limitation to the movements of the vehicles because the motion of the traffic objects is connected to the definition of the road. Thus, the traffic objects have to pass straight through the intersection. A turn in such intersection is not possible.
\subsection{Simulation environment design}
In CarMaker, it is possible to design different test traces with various numbers of intersecting arcs and lanes in the arc. After the realization of a test trace including an intersection, traffic is added to the model. For each vehicle, the host car as well as the traffic objects, the vehicle type, the reference starting point and reference speed are preset.\\ \indent
Since the host car starts always with zero velocity, the road model should be designed in a way such that the host car has reached its desired speed before entering the controlled intersection surrounding.
\subsection{Adding the MPC}
In CarMaker for Simulink, it is possible to change the vehicle model itself. The model generic.mdl given by CarMaker provides a basic CarMaker model without any additional control blocks \cite{qsguide}. It is used as a start-up model to connect the simulation environment created in CarMaker with the MPC Matlab Function block in Simulink. The CarMaker simulation model in Simulink consists of a chain of individual subsystem blocks. These blocks can not be removed, but their functionality can by changed by overwriting their input or output signals.\\ \indent
The model generic.mdl contains the following models as subsystems: \textit{Driver/Driving Maneuver}, \textit{Vehicle Control} and \textit{Vehicle}. To include the MPC block, the subsystem \textit{Vehicle Control} is modified.
By hijacking the gas and brake signals in the \textit{Vehicle Control} block in Simulink as seen in Fig. \ref{fig:CM_Implement}, the drivers wish is overwritten by the calculated values from the MPC algorithm. The gas and brake signals from the driver model are only used for the vehicle with dynamics, where the control signal calculated by the MPC for this vehicle is converted to the gas and brake signals. For the other vehicles which are static traffic objects, there is no driver model. Therefore, the calculated control signals for these two vehicles overwrite directly the acceleration signal without a conversion to gas and brake signals.
\section{Case study: Controlling three vehicles} \label{sec:casestudy}
In the selected case study, the presented MPC is tested for three cars approaching an intersection as shown in Fig. \ref{fig:CarM}.
\begin{figure}[h!]
    \centering
    \includegraphics[width=0.9\columnwidth]{Intersection_CarMaker.png}
    \caption{Created intersection crossing in CarMaker environment where the three case are approaching the intersection.}
    \label{fig:CarM}
\end{figure}
%% add picture
%%maybe we have to actualize this table in the end
% !!!!!
\begin{table}[h!]
\renewcommand{\arraystretch}{1.3}
\caption{Problem data of the case study.}
\label{data}
\centering
\begin{tabular}{c|c}
\hline
\bfseries Parameter & \bfseries Values\\
\hline
$\begin{pmatrix}v_{1r}& v_{2r}& v_{3r}\end{pmatrix}$ & $\begin{pmatrix} \unitfrac[47]{km}{h}& \unitfrac[48]{km}{h}&\unitfrac[50]{km}{h}\end{pmatrix}$\\
$\begin{pmatrix}v_{imin}& v_{imax}\end{pmatrix}$ & $\begin{pmatrix} \unitfrac[30]{km}{h}& \unitfrac[90]{km}{h}\end{pmatrix}$\\
$\begin{pmatrix}a_{imin}& a_{imax}\end{pmatrix}$ & $\begin{pmatrix} \unitfrac[-3]{m}{s^2}& \unitfrac[3]{m}{s^2}\end{pmatrix}$\\
$\begin{pmatrix} w_{i1} &w_{i2} &w_{i3} & w_{i4}\end{pmatrix}$&
$\begin{pmatrix} 1  &  5 & 7 & 1000 \end{pmatrix}$ \\
$\Delta t$ & \unit[0.6]{s}\\
\hline
\end{tabular}
\end{table}
Table \ref{data} contains the chosen parameters for the cars $i=1,2,3$. The speed and acceleration limits as well as the weights for the cost function are selected identically for all three vehicles. The desired crossing sequence is chosen to $1,2,3$. The vehicles start with different initial speed and distances from the intersection. Without a controller, car $1$ and $2$ would collide in the intersection. The MPC takes control over a vehicle when it has entered the control radius of the intersection, which is $60$ meters before and $60$ meters after the intersection. The critical region, where no collisions are allowed, is the $15\cdot15$ $m^2$ intersection crossing area. The vehicles do not turn left or right in the intersection, instead they only drive straight forward. The initial optimization horizon for every car entering the control area is N=135 meters.\\ \indent
Gathered data from the sensors of the vehicles via CarMaker is shown in Fig. \ref{fig:sim_results}. When vehicle $1$ comes closer to the intersection it can be observed that it starts to accelerate and vehicle $2$ starts to decelerate in order to avoid a collision. The third vehicle slows down to avoid a collision between the second and third vehicle. One notable part in these figures are the acceleration of the static vehicles without dynamics in the middle plot, i.e. vehicle 2 and vehicle 3. Their acceleration is fluctuating considerably more than vehicle 1 which is the vehicle with dynamics. One explanation is that the acceleration of these two static cars is directly fed from the MPC algorithm, whereas for the first car, it will be converted to gas and brake signals via a PI controller. Additional tuning on the jerk penalty of the static cars in the cost function may decrease the fluctuation. Furthermore, by looking at the last plot, it is evident that the MPC controller efficiently prohibits collisions  between the vehicles. An upward-pointing triangle means the time where the vehicle is entering the intersection and a downward-pointing triangle shows the time when it is leaving. Since there is no vertical alignment between an downward-pointing triangle and an upward-pointing triangle, there are no collisions. CarMaker provides also a video animation for visualizing the simulation results. In the video, it can be observed that the cars drive in a smooth way following the given crossing sequence and there is never more than one car in the intersection.
\begin{figure}[h!]
    \centering
    \includegraphics[width=0.52\textwidth]{plots_dpc}
    \caption{Optimal trajectories from the MPC controller. The three subplots show velocity, acceleration and position.}
    \label{fig:sim_results}
\end{figure}
\section{Conclusions} \label{sec:conclusions}
This paper provides a centralized MPC for optimal control of autonomous vehicles in the control area of an intersection. The problem is formulated as a convex quadratic problem such that the MPC equations can be solved efficiently. The controller is tested for an advanced vehicle model using the simulation tool CarMaker. The simulation results are shown in a case study that verifies that the MPC works efficiently for the advanced CarMaker vehicle model.\\ \indent
Compared to the solution presented in \cite{nikolce}, the computation time for the convex problem is decreased by using a QP solver instead of the generalized second order cone program (SOCP) solver. Using the quadratic form for the MPC, the problem can be solved very fast in every time step. The computation time is related to the distance to the intersection of each vehicle. Since it depends on the number of cars in the control area and the length of their prediction horizon, the computation time is decreased by using a shrinking prediction horizon.\\ \indent
%In the MPC design, the vehicle dynamic is modeled as a simplified point mass model. Testing the controller for an advanced vehicle model by combining CarMaker and Matlab/Simulink shows that all constraints are fulfilled, especially the prohibition of collisions. 
The MPC works efficiently for the virtual test drive, but using CarMaker as a simulation environment turned out to have some significant drawbacks. CarMaker provides an advanced vehicle model only for the host car. The other vehicles are described as static objects, which limits the result. Furthermore, due to the immense computation time for simulations, where the simulation environment of CarMaker is combined with the MPC in Matlab/Simulink, it is very costly to test the MPC for the presented simple case study. Thus, testing the virtual test drive with changed parameters like adjusted weights is problematic because of the expenditure of time. For a more extended case study, e.g. with more cars in the control area, CarMaker combined with Matlab/Simulink can be considered as ineffective as a virtual test basis.%\\ \indent
%Though CarMaker may not be the best choice as a simulation tool in order to validate the control algorithm, the program was useful to visualize and validate the controller output in a 3D environment with the plug in program IPG Movie. After a simulation it is possible to view a video animation in several different angles and camera positions and also export the visualization as movies or photos as in Figure \ref{fig:CarM}.\\ \indent
%In this paper, a fixed crossing sequence is used for testing the MPC due to the restrictions in computation time using CarMaker. The optimal crossing sequence could be found by computing the optimal solution for all permutations of crossing sequences and selecting the crossing sequence that minimizes the cost function as described in \cite{nikolce}. For applying that and validating the efficiency of the presented controller in more extended virtual case studies with more cars, desirable all with an advanced vehicle model, another simulation environment needs to be found or the existing code has to be improved regarding computation speed. A simulation environment, that can be combined with Matlab/Simulink and may be more efficient in this case, is the simulation tool PreScan, but further research on this has to be done. Future work may focus on testing other simulation strategies to validate the controller in extended virtual case studies. Another research branch may be the extension of the formulated convex problem focusing on other objectives and constraints, e.g. safety constraints when several vehicles travel on the same path.

%Another subject to investigate further is the need of adding an extra constraint for the collision avoidance. The MPC algorithm uses the current longitudinal position of each vehicle as a index of the distance to the intersection. One drawback and problem occurs when a vehicle is entering the critical region. The index of when the vehicle entered the critical zone will then be a negative integer, which can't be used to describe a index. In the algorithm is the collision avoidance constraint hence only activated until the second vehicle enters the critical region. This constraint fulfills the criteria avoid collision in this case study but a more detailed constraint that can handle negative distance to the intersection can be a more generalized solution. For example if a second vehicle $c2$ entered the intersection one meter ago, then the first car $c1$ have to be 1 meter past the critical region.

%Also, by using position as index variable for the control algorithm restrict the step index to be a at least one meter. The actual position in the Simulation environment is not all ways fulfilling this criteria and therefore is the current longitudinal position needed to be rounded to a integer value.


%\section{to do}
%\begin{itemize}
%\item matrices from result chapter generalized in the mpc chapter
%\item modeled in space, simulated in time --> position input mpc, rounding
%\item we write in the case study about how the system is able to avoid collisions efficiently, but in the introduction we mention that this system would be able to decrease fuel consumption. In the cost function you also mention that the system should penalize longitudinal acceleration and jerk to guarantee a comfortable drive. Do you have any results regarding these issues? That the system actual will decrease fuel consumption and give a comfortable drive? --> write something
%\item conclusions:how could it be implemented on real cars. kind of supervision that controls the incoming cars?
%\item You mention that the MPC can solve the problem very fast in every step. How fast is this? Is it fast enough to run in realtime on a car?
%\end{itemize}
\bibliographystyle{IEEEtran}
\bibliography{database}

\end{document}
