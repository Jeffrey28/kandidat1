<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">longAcc</span>,<span class="var type1" id="S3T2U4">exflag</span>]   = MPC (<span class="var type1" id="S4T3U7">param</span>,<span class="var type1" id="S5T5U8">const</span>,<span class="var type1" id="S6T6U9">mat</span>,<span class="var type1" id="S7T10U10">cars1</span>,<span class="var type1" id="S8T10U11">cars2</span>,<span class="var type1" id="S9T10U12">cars3</span>,<span class="var type1" id="S10T1U13">dist2Int</span>,<span class="var type1" id="S11T1U14">ax</span>,<span class="var type1" id="S12T2U15">time</span>,<span class="var type1" id="S13T1U16">vx</span>)  <span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="mxinfo " id="T2:U13"><span class="var type1" id="S3T2U19">exflag</span> = <span class="mxinfo " id="T2:U15">zeros(1,1,<span class="string">'double'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line">coder.extrinsic(<span class="string">'sparse'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line">coder.extrinsic(<span class="string">'spalloc'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">% system Matrices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="mxinfo " id="T7:U16"><span class="var type1" id="S16T7U39">A</span> = <span class="mxinfo " id="T7:U18"><span class="var type1" id="S6T6U41">mat</span>.A</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="mxinfo " id="T11:U20"><span class="var type1" id="S17T11U45">B</span> = <span class="mxinfo " id="T8:U22"><span class="var type1" id="S6T6U47">mat</span>.B</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="mxinfo " id="T11:U24"><span class="var type1" id="S18T11U51">C</span> = <span class="mxinfo " id="T11:U26"><span class="mxinfo " id="T9:U27"><span class="var type1" id="S6T6U54">mat</span>.C</span>'</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="mxinfo " id="T7:U29"><span class="var type1" id="S19T7U58">Qv</span> = <span class="mxinfo " id="T7:U31"><span class="var type1" id="S6T6U60">mat</span>.Qv</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="mxinfo " id="T7:U33"><span class="var type1" id="S20T7U64">Qt</span> = <span class="mxinfo " id="T7:U35"><span class="var type1" id="S6T6U66">mat</span>.Qt</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">% parameter data</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="mxinfo " id="T2:U37"><span class="var type1" id="S21T2U70">contR</span> = <span class="mxinfo " id="T2:U39">60</span></span>; <span class="comment">% Controlradius in meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="mxinfo " id="T2:U40"><span class="var type1" id="S22T2U74">critZ</span> = <span class="mxinfo " id="T2:U42">10</span></span>; <span class="comment">% Critical Zone in meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="mxinfo " id="T2:U43"><span class="var type1" id="S23T2U78">ds</span> = <span class="mxinfo " id="T2:U45">1</span></span>;     <span class="comment">% meters between each sample</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="mxinfo " id="T2:U46"><span class="var type1" id="S24T2U82">numCars</span> = <span class="mxinfo " id="T2:U48">3</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="mxinfo " id="T4:U49"><span class="var type1" id="S25T4U86">w</span> = <span class="mxinfo " id="T4:U51"><span class="var type1" id="S4T3U88">param</span>.weights</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="mxinfo " id="T2:U53"><span class="var type1" id="S26T2U92">tdiff</span> = <span class="mxinfo " id="T2:U55"><span class="var type1" id="S4T3U94">param</span>.timediff</span></span>; <span class="comment">% time gap between car 1 leaves and car 2 enters the intersection </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="mxinfo " id="T2:U57"><span class="var type1" id="S27T2U98">T</span> = <span class="mxinfo " id="T2:U59"><span class="var type1" id="S4T3U100">param</span>.T</span></span>; <span class="comment">% sampling time</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">% Constraints</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="mxinfo " id="T2:U61"><span class="var type1" id="S28T2U104">amax</span> = <span class="mxinfo " id="T2:U63"><span class="var type1" id="S5T5U106">const</span>.amax</span></span>; <span class="mxinfo " id="T2:U65"><span class="var type1" id="S29T2U110">amin</span> = <span class="mxinfo " id="T2:U67"><span class="var type1" id="S5T5U112">const</span>.amin</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="mxinfo " id="T2:U69"><span class="var type1" id="S30T2U116">vmax</span> = <span class="mxinfo " id="T2:U71"><span class="var type1" id="S5T5U118">const</span>.vmax</span></span> ; <span class="mxinfo " id="T2:U73"><span class="var type1" id="S31T2U122">vmin</span> = <span class="mxinfo " id="T2:U75"><span class="var type1" id="S5T5U124">const</span>.vmin</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="mxinfo " id="T12:U77"><span class="var type1" id="S32T12U128">refVel</span> = <span class="mxinfo " id="T12:U79">[<span class="mxinfo " id="T2:U80"><span class="var type1" id="S7T10U132">cars1</span>.refVel</span>, <span class="mxinfo " id="T2:U82"><span class="var type1" id="S8T10U135">cars2</span>.refVel</span>, <span class="mxinfo " id="T2:U84"><span class="var type1" id="S9T10U138">cars3</span>.refVel</span>]</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo " id="T12:U86"><span class="var type1" id="S33T12U142">meanVel</span> = <span class="mxinfo " id="T12:U88">[<span class="mxinfo " id="T2:U89"><span class="var type1" id="S7T10U146">cars1</span>.meanVel</span>, <span class="mxinfo " id="T2:U91"><span class="var type1" id="S8T10U149">cars2</span>.meanVel</span>, <span class="mxinfo " id="T2:U93"><span class="var type1" id="S9T10U152">cars3</span>.meanVel</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="comment">% current states for all cars</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="mxinfo " id="T13:U95"><span class="var type1" id="S34T13U156">xk</span> = <span class="mxinfo " id="T13:U97">[<span class="mxinfo " id="T12:U98"><span class="var type1" id="S12T2U159">time</span>, <span class="var type1" id="S12T2U160">time</span>, <span class="var type1" id="S12T2U161">time</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line">     <span class="mxinfo " id="T12:U102"><span class="mxinfo " id="T2:U103"><span class="mxinfo " id="T2:U104">1</span>/<span class="mxinfo " id="T2:U105"><span class="var type1" id="S13T1U166">vx</span>(<span class="mxinfo " id="T14:U107">1</span>)</span></span>, <span class="mxinfo " id="T2:U108"><span class="mxinfo " id="T2:U109">1</span>/<span class="mxinfo " id="T2:U110"><span class="var type1" id="S13T1U171">vx</span>(<span class="mxinfo " id="T14:U112">2</span>)</span></span>, <span class="mxinfo " id="T2:U113"><span class="mxinfo " id="T2:U114">1</span>/<span class="mxinfo " id="T2:U115"><span class="var type1" id="S13T1U176">vx</span>(<span class="mxinfo " id="T14:U117">3</span>)</span></span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="mxinfo " id="T12:U118"><span class="var type1" id="S35T12U180">uk</span> = <span class="mxinfo " id="T12:U120"><span class="mxinfo " id="T12:U121">-<span class="mxinfo " id="T12:U122"><span class="mxinfo " id="T12:U123"><span class="var type1" id="S34T13U185">xk</span>(<span class="mxinfo " id="T14:U125">2</span>,<span class="mxinfo " id="T15:U126">:</span>)</span>.^3</span></span>.*<span class="mxinfo " id="T12:U127"><span class="var type1" id="S11T1U190">ax</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="mxinfo " id="T1:U129"><span class="var type1" id="S2T1U193">longAcc</span> = <span class="mxinfo " id="T1:U131">zeros(<span class="mxinfo " id="T2:U132">3</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"><span class="mxinfo " id="T2:U133"><span class="var type1" id="S36T2U200">No</span> = <span class="mxinfo " id="T2:U135"><span class="mxinfo " id="T2:U136"><span class="mxinfo " id="T2:U137">2</span>*<span class="var type1" id="S21T2U204">contR</span></span> + <span class="var type1" id="S22T2U205">critZ</span></span></span>; <span class="comment">% maximum prediction horizon</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="comment">% N = 2*contR + critZ + (car(j).dist2Int - contR) = contR+critZ+car(j).dist2Int</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">% Prediction horizon for each cars</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="mxinfo " id="T1:U140"><span class="var type1" id="S37T1U208">N</span> = <span class="mxinfo " id="T1:U142"><span class="mxinfo " id="T2:U143"><span class="var type1" id="S21T2U211">contR</span>+<span class="var type1" id="S22T2U212">critZ</span></span>+<span class="var type1" id="S10T1U213">dist2Int</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="mxinfo " id="T16:U147"><span class="mxinfo " id="T16:U148"><span class="var type1" id="S37T1U217">N</span>(<span class="mxinfo " id="T17:U150"><span class="mxinfo " id="T17:U151"><span class="var type1" id="S37T1U220">N</span> &lt; <span class="mxinfo " id="T2:U153">0</span></span> | <span class="mxinfo " id="T17:U154"><span class="var type1" id="S37T1U223">N</span> &gt; <span class="var type1" id="S36T2U224">No</span></span></span>)</span> = <span class="mxinfo " id="T2:U157">0</span></span>; <span class="comment">% The car have to be inside the control horizon</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="comment">% % % eye zeros and ones also needed to be predifined</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="mxinfo " id="T18:U158"><span class="var type1" id="S38T18U228">Eye</span> = (<span class="mxinfo " id="T18:U160">eye(2*135)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"><span class="comment">% coder.varsize('Eye');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">% % </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="mxinfo " id="T19:U161"><span class="var type1" id="S40T19U237">Zeros</span> = (<span class="mxinfo " id="T19:U163">zeros(1170,4*135)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">% coder.varsize('Zeros');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="comment">% % </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="mxinfo " id="T20:U164"><span class="var type1" id="S41T20U247">Ones</span> = (<span class="mxinfo " id="T20:U166">ones(4*135,4*135)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="comment">% coder.varsize('Ones');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="mxinfo " id="T21:U167"><span class="var type1" id="S43T21U259">Hm</span> = <span class="mxinfo " id="T21:U169"><span class="extrinsicFcn" id="F53N11:B261">sparse</span>(<span class="mxinfo " id="T22:U170">[]</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="mxinfo " id="T23:U171"><span class="message warning" id="M1F1C"><span class="var type1" id="S45T23U266">f</span> = []</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="mxinfo " id="T24:U173"><span class="var type1" id="S46T24U271">Aeq</span> = <span class="mxinfo " id="T22:U175">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="mxinfo " id="T25:U176"><span class="message warning" id="M2F1C"><span class="var type1" id="S47T25U276">beq</span> = []</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="mxinfo " id="T26:U178"><span class="var type1" id="S48T26U281">Ain</span> = <span class="mxinfo " id="T22:U180">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="mxinfo " id="T27:U181"><span class="message warning" id="M3F1C"><span class="var type1" id="S49T27U286">bin</span> = []</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">% coder.varsize('Hm',[1562, 1562],[1,1]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line">coder.varsize(<span class="string">'f'</span>,[1562,1],[1,0]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">coder.varsize(<span class="string">'Aeq'</span>,[1170,1562],[1,1]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">coder.varsize(<span class="string">'beq'</span>,[1170,1],[1,0]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">coder.varsize(<span class="string">'Ain'</span>,[1566,1562],[1,1]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">coder.varsize(<span class="string">'bin'</span>,[1566,1],[1,0]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S50T2U361">j</span>=<span class="mxinfo " id="T1:U184"><span class="mxinfo " id="T2:U185">1</span>:<span class="var type1" id="S24T2U364">numCars</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">    <span class="comment">% When a car is inside the control region the car</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">    <span class="comment">% will be controlled of by the MPC. The horizon is limited to the exit</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">    <span class="comment">% of the control region.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">    <span class="mxinfo " id="T28:U187"><span class="keyword">if</span> <span class="mxinfo " id="T28:U188"><span class="mxinfo " id="T2:U189"><span class="var type1" id="S10T1U370">dist2Int</span>(<span class="var type1" id="S50T2U371">j</span>)</span> &lt;= <span class="var type1" id="S21T2U372">contR</span></span> &amp;&amp;  <span class="mxinfo " id="T28:U193"><span class="mxinfo " id="T2:U194"><span class="var type1" id="S10T1U375">dist2Int</span>(<span class="var type1" id="S50T2U376">j</span>)</span> &gt; <span class="mxinfo " id="T2:U197">-(<span class="mxinfo " id="T2:U198"><span class="var type1" id="S21T2U380">contR</span>+<span class="var type1" id="S22T2U381">critZ</span></span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="comment">% % Hessian Matrix and f vector        </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">    <span class="mxinfo " id="T21:U201"><span class="var type1" id="S51T21U384">Hj1</span> = <span class="mxinfo " id="T21:U203"><span class="extrinsicFcn" id="F87N11:B386">sparse</span>(<span class="mxinfo " id="T29:U204"><span class="mxinfo " id="T29:U205">kron(<span class="mxinfo " id="T29:U206"><span class="var type1" id="S38T18U391">Eye</span>(<span class="mxinfo " id="T30:U208"><span class="mxinfo " id="T2:U209">1</span>:<span class="mxinfo " id="T2:U210"><span class="var type1" id="S37T1U395">N</span>(<span class="var type1" id="S50T2U396">j</span>)</span></span>,<span class="mxinfo " id="T30:U213"><span class="mxinfo " id="T2:U214">1</span>:<span class="mxinfo " id="T2:U215"><span class="var type1" id="S37T1U400">N</span>(<span class="var type1" id="S50T2U401">j</span>)</span></span>)</span>,<span class="mxinfo " id="T7:U218"><span class="mxinfo " id="T7:U219"><span class="mxinfo " id="T7:U220"><span class="mxinfo " id="T2:U221">2</span>*<span class="var type1" id="S19T7U406">Qv</span></span>*<span class="mxinfo " id="T2:U223"><span class="var type1" id="S25T4U408">w</span>(<span class="mxinfo " id="T14:U225">1</span>)</span></span>*<span class="mxinfo " id="T2:U226"><span class="mxinfo " id="T2:U227"><span class="var type1" id="S33T12U412">meanVel</span>(<span class="var type1" id="S50T2U413">j</span>)</span>^3</span></span>)</span> + <span class="mxinfo " id="T29:U230">kron(<span class="mxinfo " id="T29:U231"><span class="var type1" id="S38T18U418">Eye</span>(<span class="mxinfo " id="T30:U233"><span class="mxinfo " id="T2:U234">1</span>:<span class="mxinfo " id="T2:U235"><span class="var type1" id="S37T1U422">N</span>(<span class="var type1" id="S50T2U423">j</span>)</span></span>,<span class="mxinfo " id="T30:U238"><span class="mxinfo " id="T2:U239">1</span>:<span class="mxinfo " id="T2:U240"><span class="var type1" id="S37T1U427">N</span>(<span class="var type1" id="S50T2U428">j</span>)</span></span>)</span>,<span class="mxinfo " id="T7:U243"><span class="var type1" id="S20T7U430">Qt</span>*<span class="mxinfo " id="T2:U245">0.00001</span></span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">    <span class="mxinfo " id="T21:U246"><span class="var type1" id="S53T21U434">Hj2</span> = <span class="mxinfo " id="T21:U248"><span class="extrinsicFcn" id="F98N11:B436">sparse</span>(<span class="mxinfo " id="T29:U249">kron(<span class="mxinfo " id="T29:U250"><span class="var type1" id="S38T18U440">Eye</span>(<span class="mxinfo " id="T30:U252"><span class="mxinfo " id="T2:U253">1</span>:<span class="mxinfo " id="T2:U254"><span class="var type1" id="S37T1U444">N</span>(<span class="var type1" id="S50T2U445">j</span>)</span></span>,<span class="mxinfo " id="T30:U257"><span class="mxinfo " id="T2:U258">1</span>:<span class="mxinfo " id="T2:U259"><span class="var type1" id="S37T1U449">N</span>(<span class="var type1" id="S50T2U450">j</span>)</span></span>)</span>,<span class="mxinfo " id="T2:U262"><span class="mxinfo " id="T2:U263"><span class="mxinfo " id="T2:U264">2</span>*<span class="mxinfo " id="T2:U265"><span class="var type1" id="S25T4U455">w</span>(<span class="mxinfo " id="T14:U267">2</span>)</span></span>*<span class="mxinfo " id="T2:U268"><span class="mxinfo " id="T2:U269"><span class="var type1" id="S33T12U459">meanVel</span>(<span class="var type1" id="S50T2U460">j</span>)</span>^5</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">    <span class="mxinfo " id="T21:U272"><span class="var type1" id="S54T21U464">Hj3</span> = <span class="mxinfo " id="T21:U274"><span class="extrinsicFcn" id="F104N11:B466">sparse</span>(<span class="mxinfo " id="T29:U275">kron(<span class="mxinfo " id="T29:U276"><span class="var type1" id="S38T18U470">Eye</span>(<span class="mxinfo " id="T30:U278"><span class="mxinfo " id="T2:U279">1</span>:<span class="mxinfo " id="T2:U280"><span class="var type1" id="S37T1U474">N</span>(<span class="var type1" id="S50T2U475">j</span>)</span></span>,<span class="mxinfo " id="T30:U283"><span class="mxinfo " id="T2:U284">1</span>:<span class="mxinfo " id="T2:U285"><span class="var type1" id="S37T1U479">N</span>(<span class="var type1" id="S50T2U480">j</span>)</span></span>)</span>,<span class="mxinfo " id="T2:U288"><span class="mxinfo " id="T2:U289"><span class="mxinfo " id="T2:U290">2</span>*<span class="mxinfo " id="T2:U291"><span class="var type1" id="S25T4U485">w</span>(<span class="mxinfo " id="T14:U293">3</span>)</span></span>*<span class="mxinfo " id="T2:U294"><span class="mxinfo " id="T2:U295"><span class="var type1" id="S33T12U489">meanVel</span>(<span class="var type1" id="S50T2U490">j</span>)</span>^7</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    <span class="mxinfo " id="T21:U298"><span class="var type1" id="S43T21U494">Hm</span> = <span class="mxinfo " id="T21:U300"><span class="extrinsicFcn" id="F105N3:B496">blkdiag</span>(<span class="var type1" id="S43T21U497">Hm</span>,<span class="var type1" id="S51T21U498">Hj1</span>,<span class="var type1" id="S53T21U499">Hj2</span>,<span class="var type1" id="S54T21U500">Hj3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">    <span class="mxinfo " id="T23:U305"><span class="var type1" id="S45T23U503">f</span> = <span class="mxinfo " id="T16:U307">[<span class="var type1" id="S45T23U506">f</span>; <span class="mxinfo " id="T16:U309">kron(<span class="mxinfo " id="T16:U310"><span class="var type1" id="S41T20U511">Ones</span>(<span class="mxinfo " id="T30:U312"><span class="mxinfo " id="T2:U313">1</span>:<span class="mxinfo " id="T2:U314"><span class="var type1" id="S37T1U515">N</span>(<span class="var type1" id="S50T2U516">j</span>)</span></span>,<span class="mxinfo " id="T14:U317">1</span>)</span>,<span class="mxinfo " id="T11:U318"><span class="mxinfo " id="T2:U319"><span class="mxinfo " id="T2:U320"><span class="mxinfo " id="T2:U321"><span class="mxinfo " id="T2:U322">-2*1</span>/<span class="mxinfo " id="T2:U323"><span class="var type1" id="S32T12U527">refVel</span>(<span class="var type1" id="S50T2U528">j</span>)</span></span>*<span class="mxinfo " id="T2:U326"><span class="var type1" id="S25T4U530">w</span>(<span class="mxinfo " id="T2:U328">1</span>)</span></span>*<span class="mxinfo " id="T2:U329"><span class="mxinfo " id="T2:U330"><span class="var type1" id="S33T12U534">meanVel</span>(<span class="var type1" id="S50T2U535">j</span>)</span>^3</span></span>*<span class="var type1" id="S18T11U537">C</span></span>)</span>; <span class="mxinfo " id="T16:U334"><span class="var type1" id="S40T19U540">Zeros</span>(<span class="mxinfo " id="T30:U336"><span class="mxinfo " id="T2:U337">1</span>:<span class="mxinfo " id="T2:U338"><span class="mxinfo " id="T2:U339">2</span>*<span class="mxinfo " id="T2:U340"><span class="var type1" id="S37T1U546">N</span>(<span class="var type1" id="S50T2U547">j</span>)</span></span></span>,<span class="mxinfo " id="T2:U343">1</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line"><span class="comment">% % Equality contraints</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">         </span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">    <span class="mxinfo " id="T29:U344"><span class="var type1" id="S56T29U551">Ha</span> = <span class="mxinfo " id="T29:U346">[<span class="mxinfo " id="T31:U347"><span class="var type1" id="S40T19U555">Zeros</span>(<span class="mxinfo " id="T32:U349">1:2</span>,<span class="mxinfo " id="T30:U350"><span class="mxinfo " id="T2:U351">1</span>:<span class="mxinfo " id="T2:U352"><span class="mxinfo " id="T2:U353">2</span>*<span class="mxinfo " id="T2:U354"><span class="var type1" id="S37T1U564">N</span>(<span class="var type1" id="S50T2U565">j</span>)</span></span></span>)</span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">          <span class="mxinfo " id="T29:U357"><span class="mxinfo " id="T29:U358">kron(<span class="mxinfo " id="T29:U359"><span class="var type1" id="S38T18U570">Eye</span>(<span class="mxinfo " id="T30:U361"><span class="mxinfo " id="T2:U362">1</span>:<span class="mxinfo " id="T2:U363"><span class="mxinfo " id="T2:U364"><span class="var type1" id="S37T1U575">N</span>(<span class="var type1" id="S50T2U576">j</span>)</span>-<span class="mxinfo " id="T2:U367">1</span></span></span>,<span class="mxinfo " id="T30:U368"><span class="mxinfo " id="T2:U369">1</span>:<span class="mxinfo " id="T2:U370"><span class="mxinfo " id="T2:U371"><span class="var type1" id="S37T1U582">N</span>(<span class="var type1" id="S50T2U583">j</span>)</span>-<span class="mxinfo " id="T2:U374">1</span></span></span>)</span>,<span class="var type1" id="S16T7U585">A</span>)</span> <span class="mxinfo " id="T33:U376"><span class="var type1" id="S40T19U587">Zeros</span>(<span class="mxinfo " id="T30:U378"><span class="mxinfo " id="T2:U379">1</span>:<span class="mxinfo " id="T2:U380">(<span class="mxinfo " id="T2:U381"><span class="mxinfo " id="T2:U382"><span class="var type1" id="S37T1U594">N</span>(<span class="var type1" id="S50T2U595">j</span>)</span>-<span class="mxinfo " id="T2:U385">1</span></span>)*<span class="mxinfo " id="T2:U386">2</span></span></span>,<span class="mxinfo " id="T9:U387"><span class="mxinfo " id="T2:U388">1</span>:<span class="mxinfo " id="T2:U389">2</span></span>)</span></span>]</span></span>; <span class="comment">% multiply x(k) with A</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">    <span class="mxinfo " id="T29:U390"><span class="var type1" id="S57T29U603">Huk</span> = <span class="mxinfo " id="T29:U392">[<span class="mxinfo " id="T34:U393"><span class="var type1" id="S40T19U607">Zeros</span>(<span class="mxinfo " id="T2:U395">1</span>,<span class="mxinfo " id="T30:U396"><span class="mxinfo " id="T2:U397">1</span>:<span class="mxinfo " id="T2:U398"><span class="var type1" id="S37T1U612">N</span>(<span class="var type1" id="S50T2U613">j</span>)</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">           <span class="mxinfo " id="T29:U401"><span class="mxinfo " id="T29:U402"><span class="var type1" id="S38T18U616">Eye</span>(<span class="mxinfo " id="T30:U404"><span class="mxinfo " id="T2:U405">1</span>:<span class="mxinfo " id="T2:U406"><span class="mxinfo " id="T2:U407"><span class="var type1" id="S37T1U621">N</span>(<span class="var type1" id="S50T2U622">j</span>)</span>-<span class="mxinfo " id="T2:U410">1</span></span></span>,<span class="mxinfo " id="T30:U411"><span class="mxinfo " id="T2:U412">1</span>:<span class="mxinfo " id="T2:U413"><span class="mxinfo " id="T2:U414"><span class="var type1" id="S37T1U628">N</span>(<span class="var type1" id="S50T2U629">j</span>)</span>-<span class="mxinfo " id="T2:U417">1</span></span></span>)</span> <span class="mxinfo " id="T16:U418"><span class="var type1" id="S40T19U632">Zeros</span>(<span class="mxinfo " id="T30:U420"><span class="mxinfo " id="T2:U421">1</span>:<span class="mxinfo " id="T2:U422"><span class="mxinfo " id="T2:U423"><span class="var type1" id="S37T1U637">N</span>(<span class="var type1" id="S50T2U638">j</span>)</span>-<span class="mxinfo " id="T2:U426">1</span></span></span>,<span class="mxinfo " id="T2:U427">1</span>)</span></span>]</span></span>;     <span class="comment">% select all u(k)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">    <span class="mxinfo " id="T29:U428"><span class="var type1" id="S58T29U643">Hukp1</span> = <span class="mxinfo " id="T29:U430"><span class="var type1" id="S38T18U645">Eye</span>(<span class="mxinfo " id="T30:U432"><span class="mxinfo " id="T2:U433">1</span>:<span class="mxinfo " id="T2:U434"><span class="var type1" id="S37T1U649">N</span>(<span class="var type1" id="S50T2U650">j</span>)</span></span>,<span class="mxinfo " id="T30:U437"><span class="mxinfo " id="T2:U438">1</span>:<span class="mxinfo " id="T2:U439"><span class="var type1" id="S37T1U654">N</span>(<span class="var type1" id="S50T2U655">j</span>)</span></span>)</span></span>; <span class="comment">% select all u(k+1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">    <span class="mxinfo " id="T29:U442"><span class="var type1" id="S59T29U658">Aeq_car</span> = <span class="mxinfo " id="T29:U444">[<span class="mxinfo " id="T29:U445"><span class="mxinfo " id="T29:U446"><span class="var type1" id="S56T29U662">Ha</span>-<span class="mxinfo " id="T29:U448"><span class="var type1" id="S38T18U664">Eye</span>(<span class="mxinfo " id="T30:U450"><span class="mxinfo " id="T2:U451">1</span>:<span class="mxinfo " id="T2:U452"><span class="mxinfo " id="T2:U453">2</span>*<span class="mxinfo " id="T2:U454"><span class="var type1" id="S37T1U670">N</span>(<span class="var type1" id="S50T2U671">j</span>)</span></span></span>,<span class="mxinfo " id="T30:U457"><span class="mxinfo " id="T2:U458">1</span>:<span class="mxinfo " id="T2:U459"><span class="mxinfo " id="T2:U460">2</span>*<span class="mxinfo " id="T2:U461"><span class="var type1" id="S37T1U677">N</span>(<span class="var type1" id="S50T2U678">j</span>)</span></span></span>)</span></span>, <span class="mxinfo " id="T29:U464">kron(<span class="mxinfo " id="T29:U465"><span class="var type1" id="S38T18U682">Eye</span>(<span class="mxinfo " id="T30:U467"><span class="mxinfo " id="T2:U468">1</span>:<span class="mxinfo " id="T2:U469"><span class="var type1" id="S37T1U686">N</span>(<span class="var type1" id="S50T2U687">j</span>)</span></span>,<span class="mxinfo " id="T30:U472"><span class="mxinfo " id="T2:U473">1</span>:<span class="mxinfo " id="T2:U474"><span class="var type1" id="S37T1U691">N</span>(<span class="var type1" id="S50T2U692">j</span>)</span></span>)</span>,<span class="var type1" id="S17T11U693">B</span>)</span>, <span class="mxinfo " id="T29:U478"><span class="var type1" id="S40T19U695">Zeros</span>(<span class="mxinfo " id="T30:U480"><span class="mxinfo " id="T2:U481">1</span>:<span class="mxinfo " id="T2:U482"><span class="mxinfo " id="T2:U483">2</span>*<span class="mxinfo " id="T2:U484"><span class="var type1" id="S37T1U701">N</span>(<span class="var type1" id="S50T2U702">j</span>)</span></span></span>,<span class="mxinfo " id="T30:U487"><span class="mxinfo " id="T2:U488">1</span>:<span class="mxinfo " id="T2:U489"><span class="var type1" id="S37T1U706">N</span>(<span class="var type1" id="S50T2U707">j</span>)</span></span>)</span></span>; <span class="comment">% A*x(k)-I(2)*x(k+1)+B*u(k)=0 </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">               <span class="mxinfo " id="T29:U492"><span class="mxinfo " id="T29:U493"><span class="var type1" id="S40T19U710">Zeros</span>(<span class="mxinfo " id="T30:U495"><span class="mxinfo " id="T2:U496">1</span>:<span class="mxinfo " id="T2:U497"><span class="var type1" id="S37T1U714">N</span>(<span class="var type1" id="S50T2U715">j</span>)</span></span>,<span class="mxinfo " id="T30:U500"><span class="mxinfo " id="T2:U501">1</span>:<span class="mxinfo " id="T2:U502"><span class="mxinfo " id="T2:U503">2</span>*<span class="mxinfo " id="T2:U504"><span class="var type1" id="S37T1U721">N</span>(<span class="var type1" id="S50T2U722">j</span>)</span></span></span>)</span>, (<span class="mxinfo " id="T29:U507"><span class="var type1" id="S58T29U725">Hukp1</span>-<span class="var type1" id="S57T29U726">Huk</span></span>), <span class="mxinfo " id="T29:U510">blkdiag(<span class="mxinfo " id="T2:U511"><span class="mxinfo " id="T2:U512"><span class="var type1" id="S13T1U731">vx</span>(<span class="var type1" id="S50T2U732">j</span>)</span>*<span class="var type1" id="S27T2U733">T</span></span>,<span class="mxinfo " id="T29:U516"><span class="var type1" id="S23T2U735">ds</span>*<span class="mxinfo " id="T29:U518"><span class="var type1" id="S38T18U737">Eye</span>(<span class="mxinfo " id="T30:U520"><span class="mxinfo " id="T2:U521">1</span>:<span class="mxinfo " id="T2:U522"><span class="mxinfo " id="T2:U523"><span class="var type1" id="S37T1U742">N</span>(<span class="var type1" id="S50T2U743">j</span>)</span>-<span class="mxinfo " id="T2:U526">1</span></span></span>,<span class="mxinfo " id="T30:U527"><span class="mxinfo " id="T2:U528">1</span>:<span class="mxinfo " id="T2:U529"><span class="mxinfo " id="T2:U530"><span class="var type1" id="S37T1U749">N</span>(<span class="var type1" id="S50T2U750">j</span>)</span>-<span class="mxinfo " id="T2:U533">1</span></span></span>)</span></span>)</span></span>]</span></span>; <span class="comment">% u'(k)*ds = u(k+1) - u(k))</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">               </span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">    <span class="mxinfo " id="T16:U534"><span class="var type1" id="S60T16U754">beq_car</span> = <span class="mxinfo " id="T16:U536">[(<span class="mxinfo " id="T11:U537"><span class="mxinfo " id="T7:U538">-<span class="var type1" id="S16T7U760">A</span></span>*<span class="mxinfo " id="T11:U540"><span class="var type1" id="S34T13U762">xk</span>(<span class="mxinfo " id="T32:U542">:</span>,<span class="var type1" id="S50T2U764">j</span>)</span></span>); <span class="mxinfo " id="T16:U544"><span class="var type1" id="S40T19U767">Zeros</span>(<span class="mxinfo " id="T30:U546"><span class="mxinfo " id="T2:U547">1</span>:<span class="mxinfo " id="T2:U548">(<span class="mxinfo " id="T2:U549"><span class="mxinfo " id="T2:U550"><span class="var type1" id="S37T1U774">N</span>(<span class="var type1" id="S50T2U775">j</span>)</span>-<span class="mxinfo " id="T2:U553">1</span></span>)*<span class="mxinfo " id="T2:U554">2</span></span></span>,<span class="mxinfo " id="T2:U555">1</span>)</span>; <span class="mxinfo " id="T2:U556"><span class="var type1" id="S35T12U781">uk</span>(<span class="var type1" id="S50T2U782">j</span>)</span>; <span class="mxinfo " id="T16:U559"><span class="var type1" id="S40T19U785">Zeros</span>(<span class="mxinfo " id="T30:U561"><span class="mxinfo " id="T2:U562">1</span>:(<span class="mxinfo " id="T2:U563"><span class="mxinfo " id="T2:U564"><span class="var type1" id="S37T1U791">N</span>(<span class="var type1" id="S50T2U792">j</span>)</span>-<span class="mxinfo " id="T2:U567">1</span></span>)</span>,<span class="mxinfo " id="T2:U568">1</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">    <span class="mxinfo " id="T24:U569"><span class="var type1" id="S46T24U797">Aeq</span> = <span class="mxinfo " id="T29:U571">blkdiag(<span class="var type1" id="S46T24U800">Aeq</span>,<span class="var type1" id="S59T29U801">Aeq_car</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">    <span class="mxinfo " id="T25:U574"><span class="var type1" id="S47T25U804">beq</span> = <span class="mxinfo " id="T16:U576">[<span class="var type1" id="S47T25U807">beq</span>;<span class="var type1" id="S60T16U809">beq_car</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">      </span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="comment">% % Inequality Constraints</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">    <span class="mxinfo " id="T29:U579"><span class="var type1" id="S61T29U812">Ain_car</span> = <span class="mxinfo " id="T29:U581">[<span class="mxinfo " id="T29:U582"><span class="mxinfo " id="T29:U583">kron(<span class="mxinfo " id="T29:U584"><span class="var type1" id="S38T18U818">Eye</span>(<span class="mxinfo " id="T30:U586"><span class="mxinfo " id="T2:U587">1</span>:<span class="mxinfo " id="T2:U588"><span class="var type1" id="S37T1U822">N</span>(<span class="var type1" id="S50T2U823">j</span>)</span></span>,<span class="mxinfo " id="T30:U591"><span class="mxinfo " id="T2:U592">1</span>:<span class="mxinfo " id="T2:U593"><span class="var type1" id="S37T1U827">N</span>(<span class="var type1" id="S50T2U828">j</span>)</span></span>)</span>,<span class="mxinfo " id="T9:U596"><span class="var type1" id="S18T11U830">C</span>'</span>)</span>, <span class="mxinfo " id="T29:U598"><span class="var type1" id="S40T19U832">Zeros</span>(<span class="mxinfo " id="T30:U600"><span class="mxinfo " id="T2:U601">1</span>:<span class="mxinfo " id="T2:U602"><span class="var type1" id="S37T1U836">N</span>(<span class="var type1" id="S50T2U837">j</span>)</span></span>,<span class="mxinfo " id="T30:U605"><span class="mxinfo " id="T2:U606">1</span>:<span class="mxinfo " id="T2:U607"><span class="mxinfo " id="T2:U608">2</span>*<span class="mxinfo " id="T2:U609"><span class="var type1" id="S37T1U843">N</span>(<span class="var type1" id="S50T2U844">j</span>)</span></span></span>)</span></span>;  <span class="comment">% 1/vx &gt;= 1/vmax                   1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line">               <span class="mxinfo " id="T29:U612"><span class="mxinfo " id="T29:U613">kron(<span class="mxinfo " id="T29:U614"><span class="var type1" id="S38T18U849">Eye</span>(<span class="mxinfo " id="T30:U616"><span class="mxinfo " id="T2:U617">1</span>:<span class="mxinfo " id="T2:U618"><span class="var type1" id="S37T1U853">N</span>(<span class="var type1" id="S50T2U854">j</span>)</span></span>,<span class="mxinfo " id="T30:U621"><span class="mxinfo " id="T2:U622">1</span>:<span class="mxinfo " id="T2:U623"><span class="var type1" id="S37T1U858">N</span>(<span class="var type1" id="S50T2U859">j</span>)</span></span>)</span>,<span class="mxinfo " id="T9:U626">-<span class="mxinfo " id="T9:U627"><span class="var type1" id="S18T11U862">C</span>'</span></span>)</span>, <span class="mxinfo " id="T29:U629"><span class="var type1" id="S40T19U864">Zeros</span>(<span class="mxinfo " id="T30:U631"><span class="mxinfo " id="T2:U632">1</span>:<span class="mxinfo " id="T2:U633"><span class="var type1" id="S37T1U868">N</span>(<span class="var type1" id="S50T2U869">j</span>)</span></span>,<span class="mxinfo " id="T30:U636"><span class="mxinfo " id="T2:U637">1</span>:<span class="mxinfo " id="T2:U638"><span class="mxinfo " id="T2:U639">2</span>*<span class="mxinfo " id="T2:U640"><span class="var type1" id="S37T1U875">N</span>(<span class="var type1" id="S50T2U876">j</span>)</span></span></span>)</span></span>; <span class="comment">% -1/vx &gt;= -1/vmin                 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">               <span class="mxinfo " id="T29:U643"><span class="mxinfo " id="T29:U644">kron(<span class="mxinfo " id="T29:U645"><span class="var type1" id="S38T18U881">Eye</span>(<span class="mxinfo " id="T30:U647"><span class="mxinfo " id="T2:U648">1</span>:<span class="mxinfo " id="T2:U649"><span class="var type1" id="S37T1U885">N</span>(<span class="var type1" id="S50T2U886">j</span>)</span></span>,<span class="mxinfo " id="T30:U652"><span class="mxinfo " id="T2:U653">1</span>:<span class="mxinfo " id="T2:U654"><span class="var type1" id="S37T1U890">N</span>(<span class="var type1" id="S50T2U891">j</span>)</span></span>)</span>,<span class="mxinfo " id="T9:U657"><span class="mxinfo " id="T2:U658"><span class="mxinfo " id="T2:U659"><span class="mxinfo " id="T2:U660">3</span>*<span class="var type1" id="S28T2U896">amax</span></span>*<span class="mxinfo " id="T2:U662"><span class="mxinfo " id="T2:U663"><span class="var type1" id="S13T1U899">vx</span>(<span class="var type1" id="S50T2U900">j</span>)</span>^2</span></span>*<span class="mxinfo " id="T9:U666"><span class="var type1" id="S18T11U903">C</span>'</span></span>)</span>, <span class="mxinfo " id="T29:U668"><span class="var type1" id="S38T18U905">Eye</span>(<span class="mxinfo " id="T30:U670"><span class="mxinfo " id="T2:U671">1</span>:<span class="mxinfo " id="T2:U672"><span class="var type1" id="S37T1U909">N</span>(<span class="var type1" id="S50T2U910">j</span>)</span></span>,<span class="mxinfo " id="T30:U675"><span class="mxinfo " id="T2:U676">1</span>:<span class="mxinfo " id="T2:U677"><span class="var type1" id="S37T1U914">N</span>(<span class="var type1" id="S50T2U915">j</span>)</span></span>)</span>, <span class="mxinfo " id="T29:U680"><span class="var type1" id="S40T19U917">Zeros</span>(<span class="mxinfo " id="T30:U682"><span class="mxinfo " id="T2:U683">1</span>:<span class="mxinfo " id="T2:U684"><span class="var type1" id="S37T1U921">N</span>(<span class="var type1" id="S50T2U922">j</span>)</span></span>,<span class="mxinfo " id="T30:U687"><span class="mxinfo " id="T2:U688">1</span>:<span class="mxinfo " id="T2:U689"><span class="var type1" id="S37T1U926">N</span>(<span class="var type1" id="S50T2U927">j</span>)</span></span>)</span></span>;  <span class="comment">% u &gt;= umin     3)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">               <span class="mxinfo " id="T29:U692"><span class="mxinfo " id="T29:U693">kron(<span class="mxinfo " id="T29:U694"><span class="var type1" id="S38T18U932">Eye</span>(<span class="mxinfo " id="T30:U696"><span class="mxinfo " id="T2:U697">1</span>:<span class="mxinfo " id="T2:U698"><span class="var type1" id="S37T1U936">N</span>(<span class="var type1" id="S50T2U937">j</span>)</span></span>,<span class="mxinfo " id="T30:U701"><span class="mxinfo " id="T2:U702">1</span>:<span class="mxinfo " id="T2:U703"><span class="var type1" id="S37T1U941">N</span>(<span class="var type1" id="S50T2U942">j</span>)</span></span>)</span>,<span class="mxinfo " id="T9:U706"><span class="mxinfo " id="T2:U707"><span class="mxinfo " id="T2:U708"><span class="mxinfo " id="T2:U709">-<span class="mxinfo " id="T2:U710">3</span></span>*<span class="var type1" id="S29T2U948">amin</span></span>*<span class="mxinfo " id="T2:U712"><span class="mxinfo " id="T2:U713"><span class="var type1" id="S13T1U951">vx</span>(<span class="var type1" id="S50T2U952">j</span>)</span>^2</span></span>*<span class="mxinfo " id="T9:U716"><span class="var type1" id="S18T11U955">C</span>'</span></span>)</span>, <span class="mxinfo " id="T29:U718">-<span class="mxinfo " id="T29:U719"><span class="var type1" id="S38T18U958">Eye</span>(<span class="mxinfo " id="T30:U721"><span class="mxinfo " id="T2:U722">1</span>:<span class="mxinfo " id="T2:U723"><span class="var type1" id="S37T1U962">N</span>(<span class="var type1" id="S50T2U963">j</span>)</span></span>,<span class="mxinfo " id="T30:U726"><span class="mxinfo " id="T2:U727">1</span>:<span class="mxinfo " id="T2:U728"><span class="var type1" id="S37T1U967">N</span>(<span class="var type1" id="S50T2U968">j</span>)</span></span>)</span></span>, <span class="mxinfo " id="T29:U731"><span class="var type1" id="S40T19U970">Zeros</span>(<span class="mxinfo " id="T30:U733"><span class="mxinfo " id="T2:U734">1</span>:<span class="mxinfo " id="T2:U735"><span class="var type1" id="S37T1U974">N</span>(<span class="var type1" id="S50T2U975">j</span>)</span></span>,<span class="mxinfo " id="T30:U738"><span class="mxinfo " id="T2:U739">1</span>:<span class="mxinfo " id="T2:U740"><span class="var type1" id="S37T1U979">N</span>(<span class="var type1" id="S50T2U980">j</span>)</span></span>)</span></span>]</span></span>; <span class="comment">% -u &gt;= -umax 4)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">           </span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">    <span class="mxinfo " id="T16:U743"><span class="var type1" id="S62T16U983">bin_car</span> = <span class="mxinfo " id="T16:U745">[<span class="mxinfo " id="T16:U746"><span class="mxinfo " id="T16:U747"><span class="mxinfo " id="T16:U748"><span class="var type1" id="S41T20U989">Ones</span>(<span class="mxinfo " id="T30:U750"><span class="mxinfo " id="T2:U751">1</span>:<span class="mxinfo " id="T2:U752"><span class="var type1" id="S37T1U993">N</span>(<span class="var type1" id="S50T2U994">j</span>)</span></span>,<span class="mxinfo " id="T14:U755">1</span>)</span>.*<span class="mxinfo " id="T2:U756">1</span></span>/<span class="var type1" id="S30T2U997">vmax</span></span>;             <span class="comment">% 1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">               <span class="mxinfo " id="T16:U758"><span class="mxinfo " id="T16:U759"><span class="var type1" id="S41T20U1001">Ones</span>(<span class="mxinfo " id="T30:U761"><span class="mxinfo " id="T2:U762">1</span>:<span class="mxinfo " id="T2:U763"><span class="var type1" id="S37T1U1005">N</span>(<span class="var type1" id="S50T2U1006">j</span>)</span></span>,<span class="mxinfo " id="T2:U766">1</span>)</span>.*(<span class="mxinfo " id="T2:U767"><span class="mxinfo " id="T2:U768">-1</span>/<span class="var type1" id="S31T2U1012">vmin</span></span>)</span>;          <span class="comment">% 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">               <span class="mxinfo " id="T16:U770"><span class="mxinfo " id="T16:U771"><span class="var type1" id="S41T20U1016">Ones</span>(<span class="mxinfo " id="T30:U773"><span class="mxinfo " id="T2:U774">1</span>:<span class="mxinfo " id="T2:U775"><span class="var type1" id="S37T1U1020">N</span>(<span class="var type1" id="S50T2U1021">j</span>)</span></span>,<span class="mxinfo " id="T2:U778">1</span>)</span>.*(<span class="mxinfo " id="T2:U779"><span class="mxinfo " id="T2:U780"><span class="mxinfo " id="T2:U781">2</span>*<span class="var type1" id="S28T2U1027">amax</span></span>/<span class="mxinfo " id="T2:U783"><span class="mxinfo " id="T2:U784"><span class="var type1" id="S13T1U1030">vx</span>(<span class="var type1" id="S50T2U1031">j</span>)</span>^3</span></span>)</span>;   <span class="comment">% 3)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">               <span class="mxinfo " id="T16:U787"><span class="mxinfo " id="T16:U788"><span class="var type1" id="S41T20U1036">Ones</span>(<span class="mxinfo " id="T30:U790"><span class="mxinfo " id="T2:U791">1</span>:<span class="mxinfo " id="T2:U792"><span class="var type1" id="S37T1U1040">N</span>(<span class="var type1" id="S50T2U1041">j</span>)</span></span>,<span class="mxinfo " id="T2:U795">1</span>)</span>.*(<span class="mxinfo " id="T2:U796"><span class="mxinfo " id="T2:U797"><span class="mxinfo " id="T2:U798">-<span class="mxinfo " id="T2:U799">2</span></span>*<span class="var type1" id="S29T2U1048">amin</span></span>/<span class="mxinfo " id="T2:U801"><span class="mxinfo " id="T2:U802"><span class="var type1" id="S13T1U1051">vx</span>(<span class="var type1" id="S50T2U1052">j</span>)</span>^3</span></span>)</span>]</span></span>;  <span class="comment">% 4)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="mxinfo " id="T26:U805"><span class="var type1" id="S48T26U1056">Ain</span> = <span class="mxinfo " id="T29:U807">blkdiag(<span class="var type1" id="S48T26U1059">Ain</span>,<span class="var type1" id="S61T29U1060">Ain_car</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">    <span class="mxinfo " id="T27:U810"><span class="var type1" id="S49T27U1063">bin</span> = <span class="mxinfo " id="T16:U812">[<span class="var type1" id="S49T27U1066">bin</span>;<span class="var type1" id="S62T16U1068">bin_car</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line"><span class="comment">% % Cronologic crossing order Car 1-&gt; Car 2 -&gt; Car 3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line"><span class="comment">% % -------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"><span class="comment">% % index for cars inside control region</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line"><span class="mxinfo " id="T16:U815"><span class="var type1" id="S63T16U1071">ind</span> = <span class="mxinfo " id="T16:U817">find(<span class="mxinfo " id="T17:U818"><span class="mxinfo " id="T17:U819"><span class="var type1" id="S10T1U1076">dist2Int</span>&lt; <span class="var type1" id="S21T2U1077">contR</span></span> &amp;  <span class="mxinfo " id="T17:U822"><span class="var type1" id="S10T1U1079">dist2Int</span> &gt; <span class="mxinfo " id="T2:U824">-(<span class="mxinfo " id="T2:U825"><span class="var type1" id="S21T2U1083">contR</span>+<span class="var type1" id="S22T2U1084">critZ</span></span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line"><span class="mxinfo " id="T2:U828"><span class="var type1" id="S65T2U1087">leni</span> = <span class="mxinfo " id="T2:U830">length(<span class="var type1" id="S63T16U1090">ind</span>)</span></span>; <span class="comment">% number of cars inside the crontrol region</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line"><span class="mxinfo " id="T2:U832"><span class="var type1" id="S67T2U1093">ns</span> = <span class="mxinfo " id="T2:U834">0</span></span>; <span class="comment">% number of added slack variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line"><span class="keyword">if</span>  <span class="mxinfo " id="T28:U835"><span class="var type1" id="S65T2U1098">leni</span> &gt;= <span class="mxinfo " id="T2:U837">2</span></span> <span class="comment">% if 2 or more cars is in the control region</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S50T2U1102">j</span>=<span class="mxinfo " id="T16:U839"><span class="mxinfo " id="T2:U840">1</span>: <span class="mxinfo " id="T2:U841"><span class="mxinfo " id="T2:U842">length(<span class="var type1" id="S63T16U1108">ind</span>)</span>-<span class="mxinfo " id="T2:U844">1</span></span></span> <span class="comment">% itterate all vehicle pairs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">        <span class="mxinfo " id="T2:U845"><span class="var type1" id="S68T2U1112">leave</span> = (<span class="mxinfo " id="T2:U847"><span class="mxinfo " id="T2:U848"><span class="var type1" id="S10T1U1116">dist2Int</span>(<span class="mxinfo " id="T2:U850"><span class="var type1" id="S63T16U1118">ind</span>(<span class="var type1" id="S50T2U1119">j</span>)</span>)</span>+<span class="var type1" id="S22T2U1120">critZ</span></span>)</span>; <span class="comment">% index [m] for first car to leave</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">        <span class="mxinfo " id="T2:U854"><span class="var type1" id="S69T2U1123">enter</span> = (<span class="mxinfo " id="T2:U856"><span class="var type1" id="S10T1U1126">dist2Int</span>(<span class="mxinfo " id="T2:U858"><span class="var type1" id="S63T16U1128">ind</span>(<span class="mxinfo " id="T2:U860"><span class="var type1" id="S50T2U1130">j</span>+<span class="mxinfo " id="T2:U862">1</span></span>)</span>)</span>)</span>; <span class="comment">% index [m] for next car to enter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">        <span class="comment">% if the indexes is positive add a slack variable for the vehicle pair</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T28:U863"><span class="mxinfo " id="T2:U864">min(<span class="var type1" id="S68T2U1137">leave</span>,<span class="var type1" id="S69T2U1138">enter</span>)</span> &gt;= <span class="mxinfo " id="T2:U867">1</span></span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">            <span class="mxinfo " id="T2:U868"><span class="var type1" id="S67T2U1142">ns</span> = <span class="mxinfo " id="T2:U870"><span class="var type1" id="S67T2U1144">ns</span>+<span class="mxinfo " id="T2:U872">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">            <span class="mxinfo " id="T26:U873"><span class="var type1" id="S48T26U1148">Ain</span> = <span class="mxinfo " id="T29:U875">blkdiag(<span class="var type1" id="S48T26U1151">Ain</span>,zeros(3,1))</span></span>; <span class="comment">% Add three rows for slack constraint</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">            <span class="mxinfo " id="T27:U877"><span class="var type1" id="S49T27U1158">bin</span> = <span class="mxinfo " id="T16:U879">vertcat(<span class="var type1" id="S49T27U1161">bin</span>,<span class="mxinfo " id="T1:U881">zeros(<span class="mxinfo " id="T2:U882">3</span>,1)</span>)</span></span>; <span class="comment">% -||-</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">            <span class="mxinfo " id="T2:U883"><span class="mxinfo " id="T2:U884"><span class="var type1" id="S48T26U1169">Ain</span>(<span class="mxinfo " id="T2:U886"><span class="mxinfo " id="T2:U887">end</span>-<span class="mxinfo " id="T2:U888">2</span></span>,<span class="mxinfo " id="T2:U889"><span class="mxinfo " id="T2:U890"><span class="mxinfo " id="T2:U891"><span class="mxinfo " id="T2:U892">2</span>*<span class="var type1" id="S68T2U1178">leave</span></span>-<span class="mxinfo " id="T2:U894">1</span></span> + <span class="mxinfo " id="T2:U895"><span class="mxinfo " id="T2:U896">4</span>*<span class="mxinfo " id="T2:U897">sum(<span class="mxinfo " id="T16:U898"><span class="var type1" id="S37T1U1185">N</span>(<span class="mxinfo " id="T30:U900"><span class="mxinfo " id="T2:U901">1</span>:(<span class="mxinfo " id="T2:U902"><span class="mxinfo " id="T2:U903"><span class="var type1" id="S63T16U1191">ind</span>(<span class="var type1" id="S50T2U1192">j</span>)</span>-<span class="mxinfo " id="T2:U906">1</span></span>)</span>)</span>)</span></span></span>)</span> = <span class="mxinfo " id="T2:U907">-1</span></span>;  <span class="comment">% 1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">            <span class="mxinfo " id="T2:U908"><span class="mxinfo " id="T2:U909"><span class="var type1" id="S48T26U1199">Ain</span>(<span class="mxinfo " id="T2:U911"><span class="mxinfo " id="T2:U912">end</span>-<span class="mxinfo " id="T2:U913">2</span></span>,<span class="mxinfo " id="T2:U914"><span class="mxinfo " id="T2:U915"><span class="mxinfo " id="T2:U916"><span class="mxinfo " id="T2:U917">2</span>*<span class="var type1" id="S69T2U1208">enter</span></span>-<span class="mxinfo " id="T2:U919">1</span></span> + <span class="mxinfo " id="T2:U920"><span class="mxinfo " id="T2:U921">4</span>*<span class="mxinfo " id="T2:U922">sum(<span class="mxinfo " id="T16:U923"><span class="var type1" id="S37T1U1215">N</span>(<span class="mxinfo " id="T30:U925"><span class="mxinfo " id="T2:U926">1</span>:(<span class="mxinfo " id="T2:U927"><span class="mxinfo " id="T2:U928"><span class="var type1" id="S63T16U1221">ind</span>(<span class="mxinfo " id="T2:U930"><span class="var type1" id="S50T2U1223">j</span>+<span class="mxinfo " id="T2:U932">1</span></span>)</span>-<span class="mxinfo " id="T2:U933">1</span></span>)</span>)</span>)</span></span></span>)</span> = <span class="mxinfo " id="T2:U934">1</span></span>; <span class="comment">% 1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">            <span class="mxinfo " id="T2:U935"><span class="mxinfo " id="T2:U936"><span class="var type1" id="S48T26U1230">Ain</span>(<span class="mxinfo " id="T2:U938"><span class="mxinfo " id="T2:U939">end</span>-<span class="mxinfo " id="T2:U940">1</span></span>,<span class="mxinfo " id="T2:U941"><span class="mxinfo " id="T2:U942"><span class="mxinfo " id="T2:U943"><span class="mxinfo " id="T2:U944">2</span>*<span class="var type1" id="S68T2U1239">leave</span></span>-<span class="mxinfo " id="T2:U946">1</span></span> + <span class="mxinfo " id="T2:U947"><span class="mxinfo " id="T2:U948">4</span>*<span class="mxinfo " id="T2:U949">sum(<span class="mxinfo " id="T16:U950"><span class="var type1" id="S37T1U1246">N</span>(<span class="mxinfo " id="T30:U952"><span class="mxinfo " id="T2:U953">1</span>:(<span class="mxinfo " id="T2:U954"><span class="mxinfo " id="T2:U955"><span class="var type1" id="S63T16U1252">ind</span>(<span class="var type1" id="S50T2U1253">j</span>)</span>-<span class="mxinfo " id="T2:U958">1</span></span>)</span>)</span>)</span></span></span>)</span> = <span class="mxinfo " id="T2:U959">-1</span></span>;  <span class="comment">% 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">            <span class="mxinfo " id="T2:U960"><span class="mxinfo " id="T2:U961"><span class="var type1" id="S48T26U1260">Ain</span>(<span class="mxinfo " id="T2:U963"><span class="mxinfo " id="T2:U964">end</span>-<span class="mxinfo " id="T2:U965">1</span></span>,<span class="mxinfo " id="T2:U966"><span class="mxinfo " id="T2:U967"><span class="mxinfo " id="T2:U968"><span class="mxinfo " id="T2:U969">2</span>*<span class="var type1" id="S69T2U1269">enter</span></span>-<span class="mxinfo " id="T2:U971">1</span></span> + <span class="mxinfo " id="T2:U972"><span class="mxinfo " id="T2:U973">4</span>*<span class="mxinfo " id="T2:U974">sum(<span class="mxinfo " id="T16:U975"><span class="var type1" id="S37T1U1276">N</span>(<span class="mxinfo " id="T30:U977"><span class="mxinfo " id="T2:U978">1</span>:(<span class="mxinfo " id="T2:U979"><span class="mxinfo " id="T2:U980"><span class="var type1" id="S63T16U1282">ind</span>(<span class="mxinfo " id="T2:U982"><span class="var type1" id="S50T2U1284">j</span>+<span class="mxinfo " id="T2:U984">1</span></span>)</span>-<span class="mxinfo " id="T2:U985">1</span></span>)</span>)</span>)</span></span></span>)</span> = <span class="mxinfo " id="T2:U986">1</span></span>; <span class="comment">% 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">            <span class="mxinfo " id="T2:U987"><span class="mxinfo " id="T2:U988"><span class="var type1" id="S48T26U1291">Ain</span>(<span class="mxinfo " id="T2:U990"><span class="mxinfo " id="T2:U991">end</span>-<span class="mxinfo " id="T2:U992">1</span></span>,<span class="mxinfo " id="T2:U993">end</span>)</span> = <span class="mxinfo " id="T2:U994">1</span></span>;                                  <span class="comment">% 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">            <span class="mxinfo " id="T2:U995"><span class="mxinfo " id="T2:U996"><span class="var type1" id="S49T27U1302">bin</span>(<span class="mxinfo " id="T2:U998"><span class="mxinfo " id="T2:U999">end</span>-<span class="mxinfo " id="T2:U1000">1</span></span>)</span> = <span class="var type1" id="S26T2U1307">tdiff</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">            <span class="mxinfo " id="T2:U1002"><span class="mxinfo " id="T2:U1003"><span class="var type1" id="S48T26U1311">Ain</span>(<span class="mxinfo " id="T2:U1005">end</span>,<span class="mxinfo " id="T2:U1006">end</span>)</span> = <span class="mxinfo " id="T2:U1007">1</span></span>;                                    <span class="comment">% 3)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">            <span class="comment">% 1) t(car_2(enter)) - t(car_1(leave)) &gt;= 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">            <span class="comment">% 2) t(car_2(enter)) - t(car_1(leave)) + q &gt;= tdiff</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">            <span class="comment">% 3) q &gt;= 0  </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T28:U1008"><span class="var type1" id="S67T2U1320">ns</span> &gt; <span class="mxinfo " id="T2:U1010">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">    <span class="mxinfo " id="T24:U1011"><span class="var type1" id="S46T24U1324">Aeq</span> = <span class="mxinfo " id="T29:U1013">[<span class="var type1" id="S46T24U1327">Aeq</span>, <span class="mxinfo " id="T29:U1015"><span class="var type1" id="S40T19U1329">Zeros</span>(<span class="mxinfo " id="T30:U1017"><span class="mxinfo " id="T2:U1018">1</span>:<span class="mxinfo " id="T2:U1019">size(<span class="var type1" id="S46T24U1334">Aeq</span>,1)</span></span>,<span class="mxinfo " id="T30:U1021"><span class="mxinfo " id="T2:U1022">1</span>:<span class="var type1" id="S67T2U1338">ns</span></span>)</span>]</span></span>; <span class="comment">% Add variable q for each slack variable</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line">    <span class="mxinfo " id="T21:U1024"><span class="var type1" id="S43T21U1341">Hm</span> = <span class="mxinfo " id="T21:U1026"><span class="extrinsicFcn" id="F233N3:B1343">blkdiag</span>(<span class="var type1" id="S43T21U1344">Hm</span>,<span class="mxinfo " id="T29:U1028">kron(<span class="mxinfo " id="T29:U1029"><span class="var type1" id="S38T18U1348">Eye</span>(<span class="mxinfo " id="T30:U1031"><span class="mxinfo " id="T2:U1032">1</span>:<span class="var type1" id="S67T2U1351">ns</span></span>,<span class="mxinfo " id="T30:U1034"><span class="mxinfo " id="T2:U1035">1</span>:<span class="var type1" id="S67T2U1354">ns</span></span>)</span>,<span class="mxinfo " id="T2:U1037"><span class="mxinfo " id="T2:U1038">2</span>*<span class="mxinfo " id="T2:U1039"><span class="var type1" id="S25T4U1358">w</span>(<span class="mxinfo " id="T14:U1041">4</span>)</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line">    <span class="mxinfo " id="T23:U1042"><span class="var type1" id="S45T23U1362">f</span> = <span class="mxinfo " id="T16:U1044">[<span class="var type1" id="S45T23U1365">f</span>; <span class="mxinfo " id="T16:U1046"><span class="var type1" id="S40T19U1368">Zeros</span>(<span class="mxinfo " id="T30:U1048"><span class="mxinfo " id="T2:U1049">1</span>:<span class="var type1" id="S67T2U1371">ns</span></span>,<span class="mxinfo " id="T2:U1051">1</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line"><span class="comment">% % If any car is within the control region the MPC will optimize the path</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line"><span class="comment">% % for all cars within the controlling region.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T28:U1052">~<span class="mxinfo " id="T21:U1053"><span class="extrinsicFcn" id="F234N8:B1377">isempty</span>(<span class="var type1" id="S43T21U1378">Hm</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">    <span class="mxinfo " id="T21:U1055">[<span class="var type1" id="S76T21U1382">L</span>,<span class="mxinfo " id="T2:U1057">~</span>] = <span class="extrinsicFcn" id="F235N4:B1385">chol</span>(<span class="var type1" id="S43T21U1386">Hm</span>,<span class="mxinfo " id="T35:U1059"><span class="string">'lower'</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">    <span class="mxinfo " id="T21:U1060"><span class="var type1" id="S78T21U1390">Linv</span> = <span class="mxinfo " id="T21:U1062"><span class="extrinsicFcn" id="F236N7:B1392">inv</span>(<span class="var type1" id="S76T21U1393">L</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">    <span class="mxinfo " id="T21:U1064"><span class="var type1" id="S80T21U1396">x</span> =  <span class="mxinfo " id="T21:U1066"><span class="extrinsicFcn" id="F239N10:B1398">spalloc</span>(<span class="mxinfo " id="T21:U1067"><span class="extrinsicFcn" id="F237N9:B1400">size</span>(<span class="var type1" id="S78T21U1401">Linv</span>,<span class="mxinfo " id="T2:U1069">2</span>)</span>,<span class="mxinfo " id="T2:U1070">1</span>,<span class="mxinfo " id="T21:U1071"><span class="extrinsicFcn" id="F238N9:B1405">size</span>(<span class="var type1" id="S78T21U1406">Linv</span>,<span class="mxinfo " id="T2:U1073">2</span>)</span>)</span></span>;<span class="comment">% ones(size(Linv,2),1);% zeros(size(Linv,2),1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">    <span class="mxinfo " id="T36:U1074"><span class="var type1" id="S82T36U1410">opt</span>= <span class="mxinfo " id="T36:U1076">mpcqpsolverOptions(<span class="string">'double'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">   <span class="comment">% tic;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line"><span class="comment">%     [x,exflag] = mpcqpsolver(Linv,f,Ain,bin,Aeq,beq,false(size(bin)),opt); %,options);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line">    <span class="comment">% time = toc;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T28:U1077"><span class="var type1" id="S3T2U1417">exflag</span> == <span class="mxinfo " id="T2:U1079">-<span class="mxinfo " id="T2:U1080">2</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">        disp(<span class="string">'Error: exflag == 2 '</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S50T2U1426">j</span>=<span class="mxinfo " id="T1:U1082"><span class="mxinfo " id="T2:U1083">1</span>:<span class="var type1" id="S24T2U1429">numCars</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line">        <span class="mxinfo " id="T2:U1085"><span class="var type1" id="S85T2U1432">prev</span> = <span class="mxinfo " id="T2:U1087"><span class="mxinfo " id="T2:U1088">4</span>*<span class="mxinfo " id="T2:U1089">sum(<span class="mxinfo " id="T16:U1090"><span class="var type1" id="S37T1U1438">N</span>(<span class="mxinfo " id="T30:U1092"><span class="mxinfo " id="T2:U1093">1</span>:<span class="mxinfo " id="T2:U1094"><span class="var type1" id="S50T2U1442">j</span>-<span class="mxinfo " id="T2:U1096">1</span></span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T28:U1097"><span class="mxinfo " id="T2:U1098"><span class="var type1" id="S37T1U1448">N</span>(<span class="var type1" id="S50T2U1449">j</span>)</span> &gt; <span class="mxinfo " id="T2:U1101">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line">            <span class="var type0" id="S2T0U1454">longAcc</span>(<span class="var type0" id="S50T0U1455">j</span>) = -<span class="message error" id="M4F1C"><span class="var type1" id="S80T21U1459">x</span>(<span class="mxinfo " id="T2:U1103"><span class="mxinfo " id="T2:U1104"><span class="mxinfo " id="T2:U1105"><span class="mxinfo " id="T2:U1106">2</span>*<span class="mxinfo " id="T2:U1107"><span class="var type1" id="S37T1U1465">N</span>(<span class="var type1" id="S50T2U1466">j</span>)</span></span>+<span class="mxinfo " id="T2:U1110">1</span></span> + <span class="var type1" id="S85T2U1468">prev</span></span>)</span>/ <span class="var type0" id="S80T0U1471">x</span>(2 + <span class="var type0" id="S85T0U1474">prev</span>)^3;</span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line">            <span class="mxinfo " id="T2:U1112"><span class="mxinfo " id="T2:U1113"><span class="var type1" id="S2T1U1480">longAcc</span>(<span class="var type1" id="S50T2U1481">j</span>)</span> = <span class="mxinfo " id="T2:U1116">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S50T2U1486">j</span>=<span class="mxinfo " id="T1:U1118"><span class="mxinfo " id="T2:U1119">1</span>:<span class="var type1" id="S24T2U1489">numCars</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line">        <span class="mxinfo " id="T2:U1121"><span class="mxinfo " id="T2:U1122"><span class="var type1" id="S2T1U1493">longAcc</span>(<span class="var type1" id="S50T2U1494">j</span>)</span> = <span class="mxinfo " id="T2:U1125">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line"></span></span>
</pre>
