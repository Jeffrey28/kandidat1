<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">longAcc</span>, <span class="var type1" id="S3T2U4">xvec</span>,<span class="var type1" id="S4T3U5">exflag</span>]   = MPC (<span class="var type1" id="S5T4U8">param</span>,<span class="var type1" id="S6T6U9">const</span>,<span class="var type1" id="S7T7U10">mat</span>,<span class="var type1" id="S8T11U11">cars1</span>,<span class="var type1" id="S9T11U12">cars2</span>,<span class="var type1" id="S10T11U13">cars3</span>,<span class="var type1" id="S11T1U14">dist2Int</span>,<span class="var type1" id="S12T1U15">ax</span>,<span class="var type1" id="S13T3U16">time</span>,<span class="var type1" id="S14T1U17">vx</span>)  </span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="mxinfo " id="T3:U14"><span class="var type1" id="S4T3U20">exflag</span> = <span class="mxinfo " id="T3:U16">zeros(1,1,<span class="string">'double'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line">coder.extrinsic(<span class="string">'quadprog'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="mxinfo " id="T2:U17"><span class="var type1" id="S3T2U34">xvec</span> = <span class="mxinfo " id="T2:U19">zeros(<span class="mxinfo " id="T3:U20">135*4*3+2</span>,1)</span></span>; <span class="comment">%#ok&lt;PREALL&gt;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">% coder.extrinsic('sparse');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">% coder.extrinsic('spalloc');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">% system Matrices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="mxinfo " id="T8:U21"><span class="var type1" id="S17T8U47">A</span> = <span class="mxinfo " id="T8:U23"><span class="var type1" id="S7T7U49">mat</span>.A</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="mxinfo " id="T12:U25"><span class="var type1" id="S18T12U53">B</span> = <span class="mxinfo " id="T9:U27"><span class="var type1" id="S7T7U55">mat</span>.B</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="mxinfo " id="T12:U29"><span class="var type1" id="S19T12U59">C</span> = <span class="mxinfo " id="T12:U31"><span class="mxinfo " id="T10:U32"><span class="var type1" id="S7T7U62">mat</span>.C</span>'</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="mxinfo " id="T8:U34"><span class="var type1" id="S20T8U66">Qv</span> = <span class="mxinfo " id="T8:U36"><span class="var type1" id="S7T7U68">mat</span>.Qv</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="mxinfo " id="T8:U38"><span class="var type1" id="S21T8U72">Qt</span> = <span class="mxinfo " id="T8:U40"><span class="var type1" id="S7T7U74">mat</span>.Qt</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">% parameter data</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="mxinfo " id="T3:U42"><span class="var type1" id="S22T3U78">contR</span> = <span class="mxinfo " id="T3:U44">60</span></span>; <span class="comment">% Controlradius in meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="mxinfo " id="T3:U45"><span class="var type1" id="S23T3U82">critZ</span> = <span class="mxinfo " id="T3:U47">10</span></span>; <span class="comment">% Critical Zone in meters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="mxinfo " id="T3:U48"><span class="var type1" id="S24T3U86">ds</span> = <span class="mxinfo " id="T3:U50">1</span></span>;     <span class="comment">% meters between each sample</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="mxinfo " id="T3:U51"><span class="var type1" id="S25T3U90">numCars</span> = <span class="mxinfo " id="T3:U53">3</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="mxinfo " id="T5:U54"><span class="var type1" id="S26T5U94">w</span> = <span class="mxinfo " id="T5:U56"><span class="var type1" id="S5T4U96">param</span>.weights</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="mxinfo " id="T3:U58"><span class="var type1" id="S27T3U100">tdiff</span> = <span class="mxinfo " id="T3:U60"><span class="var type1" id="S5T4U102">param</span>.timediff</span></span>; <span class="comment">% time gap between car 1 leaves and car 2 enters the intersection </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="mxinfo " id="T3:U62"><span class="var type1" id="S28T3U106">T</span> = <span class="mxinfo " id="T3:U64"><span class="var type1" id="S5T4U108">param</span>.T</span></span>; <span class="comment">% sampling time</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="comment">% Constraints</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="mxinfo " id="T3:U66"><span class="var type1" id="S29T3U112">amax</span> = <span class="mxinfo " id="T3:U68"><span class="var type1" id="S6T6U114">const</span>.amax</span></span>; <span class="mxinfo " id="T3:U70"><span class="var type1" id="S30T3U118">amin</span> = <span class="mxinfo " id="T3:U72"><span class="var type1" id="S6T6U120">const</span>.amin</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="mxinfo " id="T3:U74"><span class="var type1" id="S31T3U124">vmax</span> = <span class="mxinfo " id="T3:U76"><span class="var type1" id="S6T6U126">const</span>.vmax</span></span> ; <span class="mxinfo " id="T3:U78"><span class="var type1" id="S32T3U130">vmin</span> = <span class="mxinfo " id="T3:U80"><span class="var type1" id="S6T6U132">const</span>.vmin</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="mxinfo " id="T13:U82"><span class="var type1" id="S33T13U136">refVel</span> = <span class="mxinfo " id="T13:U84">[<span class="mxinfo " id="T3:U85"><span class="var type1" id="S8T11U140">cars1</span>.refVel</span>, <span class="mxinfo " id="T3:U87"><span class="var type1" id="S9T11U143">cars2</span>.refVel</span>, <span class="mxinfo " id="T3:U89"><span class="var type1" id="S10T11U146">cars3</span>.refVel</span>]</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo " id="T13:U91"><span class="var type1" id="S34T13U150">meanVel</span> = <span class="mxinfo " id="T13:U93">[<span class="mxinfo " id="T3:U94"><span class="var type1" id="S8T11U154">cars1</span>.meanVel</span>, <span class="mxinfo " id="T3:U96"><span class="var type1" id="S9T11U157">cars2</span>.meanVel</span>, <span class="mxinfo " id="T3:U98"><span class="var type1" id="S10T11U160">cars3</span>.meanVel</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="comment">% current states for all cars</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="mxinfo " id="T14:U100"><span class="var type1" id="S35T14U164">xk</span> = <span class="mxinfo " id="T14:U102">[<span class="mxinfo " id="T13:U103"><span class="var type1" id="S13T3U167">time</span>, <span class="var type1" id="S13T3U168">time</span>, <span class="var type1" id="S13T3U169">time</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">     <span class="mxinfo " id="T13:U107"><span class="mxinfo " id="T3:U108"><span class="mxinfo " id="T3:U109">1</span>/<span class="mxinfo " id="T3:U110"><span class="var type1" id="S14T1U174">vx</span>(<span class="mxinfo " id="T15:U112">1</span>)</span></span>, <span class="mxinfo " id="T3:U113"><span class="mxinfo " id="T3:U114">1</span>/<span class="mxinfo " id="T3:U115"><span class="var type1" id="S14T1U179">vx</span>(<span class="mxinfo " id="T15:U117">2</span>)</span></span>, <span class="mxinfo " id="T3:U118"><span class="mxinfo " id="T3:U119">1</span>/<span class="mxinfo " id="T3:U120"><span class="var type1" id="S14T1U184">vx</span>(<span class="mxinfo " id="T15:U122">3</span>)</span></span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="mxinfo " id="T13:U123"><span class="var type1" id="S36T13U188">uk</span> = <span class="mxinfo " id="T13:U125"><span class="mxinfo " id="T13:U126">-<span class="mxinfo " id="T13:U127"><span class="mxinfo " id="T13:U128"><span class="var type1" id="S35T14U193">xk</span>(<span class="mxinfo " id="T15:U130">2</span>,<span class="mxinfo " id="T16:U131">:</span>)</span>.^3</span></span>.*<span class="mxinfo " id="T13:U132"><span class="var type1" id="S12T1U198">ax</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="mxinfo " id="T1:U134"><span class="var type1" id="S2T1U201">longAcc</span> = <span class="mxinfo " id="T1:U136">zeros(<span class="mxinfo " id="T3:U137">3</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="mxinfo " id="T3:U138"><span class="var type1" id="S37T3U208">No</span> = <span class="mxinfo " id="T3:U140"><span class="mxinfo " id="T3:U141"><span class="mxinfo " id="T3:U142">2</span>*<span class="var type1" id="S22T3U212">contR</span></span> + <span class="var type1" id="S23T3U213">critZ</span></span></span>; <span class="comment">% maximum prediction horizon</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">% N = 2*contR + critZ + (car(j).dist2Int - contR) = contR+critZ+car(j).dist2Int</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">% Prediction horizon for each cars</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="mxinfo " id="T1:U145"><span class="var type1" id="S38T1U216">N</span> = <span class="mxinfo " id="T1:U147"><span class="mxinfo " id="T3:U148"><span class="var type1" id="S22T3U219">contR</span>+<span class="var type1" id="S23T3U220">critZ</span></span>+<span class="var type1" id="S11T1U221">dist2Int</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="mxinfo " id="T17:U152"><span class="mxinfo " id="T17:U153"><span class="var type1" id="S38T1U225">N</span>(<span class="mxinfo " id="T18:U155"><span class="mxinfo " id="T18:U156"><span class="var type1" id="S38T1U228">N</span> &lt; <span class="mxinfo " id="T3:U158">0</span></span> | <span class="mxinfo " id="T18:U159"><span class="var type1" id="S38T1U231">N</span> &gt; <span class="var type1" id="S37T3U232">No</span></span></span>)</span> = <span class="mxinfo " id="T3:U162">0</span></span>; <span class="comment">% The car have to be inside the control horizon</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="mxinfo " id="T1:U163"><span class="var type1" id="S38T1U236">N</span> = <span class="mxinfo " id="T1:U165"><span class="var type1" id="S38T1U238">N</span>/<span class="var type1" id="S24T3U239">ds</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">% % % eye zeros and ones also needed to be predifined</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="mxinfo " id="T19:U168"><span class="var type1" id="S39T19U242">Eye</span> = (<span class="mxinfo " id="T19:U170">eye(2*135)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">% coder.varsize('Eye');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="comment">% % </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="mxinfo " id="T20:U171"><span class="var type1" id="S41T20U251">Zeros</span> = (<span class="mxinfo " id="T20:U173">zeros(1170,4*135)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="comment">% coder.varsize('Zeros');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="comment">% % </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="mxinfo " id="T21:U174"><span class="var type1" id="S42T21U261">Ones</span> = (<span class="mxinfo " id="T21:U176">ones(4*135,4*135)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="comment">% coder.varsize('Ones');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="mxinfo " id="T22:U177"><span class="var type1" id="S44T22U273">Hm</span> = <span class="mxinfo " id="T23:U179">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="mxinfo " id="T24:U180"><span class="message warning" id="M1F1C"><span class="var type1" id="S45T24U278">f</span> = []</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="mxinfo " id="T25:U182"><span class="var type1" id="S46T25U283">Aeq</span> = <span class="mxinfo " id="T23:U184">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="mxinfo " id="T26:U185"><span class="message warning" id="M2F1C"><span class="var type1" id="S47T26U288">beq</span> = []</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="mxinfo " id="T27:U187"><span class="var type1" id="S48T27U293">Ain</span> = <span class="mxinfo " id="T23:U189">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="mxinfo " id="T28:U190"><span class="message warning" id="M3F1C"><span class="var type1" id="S49T28U298">bin</span> = []</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">coder.varsize(<span class="string">'Hm'</span>,[1562, 1562],[1,1]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">coder.varsize(<span class="string">'f'</span>,[1562,1],[1,0]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">coder.varsize(<span class="string">'Aeq'</span>,[1170,1562],[1,1]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">coder.varsize(<span class="string">'beq'</span>,[1170,1],[1,0]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">coder.varsize(<span class="string">'Ain'</span>,[1566,1562],[1,1]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">coder.varsize(<span class="string">'bin'</span>,[1566,1],[1,0]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">coder.varsize(<span class="string">'x'</span>,[1562,1],[1,0]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S50T3U401">j</span>=<span class="mxinfo " id="T1:U193"><span class="mxinfo " id="T3:U194">1</span>:<span class="var type1" id="S25T3U404">numCars</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">    <span class="comment">% When a car is inside the control region the car</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="comment">% will be controlled of by the MPC. The horizon is limited to the exit</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">    <span class="comment">% of the control region.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">    <span class="mxinfo " id="T29:U196"><span class="keyword">if</span> <span class="mxinfo " id="T29:U197"><span class="mxinfo " id="T3:U198"><span class="var type1" id="S11T1U410">dist2Int</span>(<span class="var type1" id="S50T3U411">j</span>)</span> &lt;= <span class="var type1" id="S22T3U412">contR</span></span> &amp;&amp;  <span class="mxinfo " id="T29:U202"><span class="mxinfo " id="T3:U203"><span class="var type1" id="S11T1U415">dist2Int</span>(<span class="var type1" id="S50T3U416">j</span>)</span> &gt; <span class="mxinfo " id="T3:U206">-(<span class="mxinfo " id="T3:U207"><span class="var type1" id="S22T3U420">contR</span>+<span class="var type1" id="S23T3U421">critZ</span></span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="comment">% % Hessian Matrix and f vector        </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    <span class="mxinfo " id="T30:U210"><span class="var type1" id="S51T30U424">Hj1</span> = <span class="mxinfo " id="T30:U212"><span class="mxinfo " id="T30:U213">kron(<span class="mxinfo " id="T30:U214"><span class="var type1" id="S39T19U429">Eye</span>(<span class="mxinfo " id="T31:U216"><span class="mxinfo " id="T3:U217">1</span>:<span class="mxinfo " id="T3:U218"><span class="var type1" id="S38T1U433">N</span>(<span class="var type1" id="S50T3U434">j</span>)</span></span>,<span class="mxinfo " id="T31:U221"><span class="mxinfo " id="T3:U222">1</span>:<span class="mxinfo " id="T3:U223"><span class="var type1" id="S38T1U438">N</span>(<span class="var type1" id="S50T3U439">j</span>)</span></span>)</span>,<span class="mxinfo " id="T8:U226"><span class="mxinfo " id="T8:U227"><span class="mxinfo " id="T8:U228"><span class="mxinfo " id="T3:U229">2</span>*<span class="var type1" id="S20T8U444">Qv</span></span>*<span class="mxinfo " id="T3:U231"><span class="var type1" id="S26T5U446">w</span>(<span class="mxinfo " id="T15:U233">1</span>)</span></span>*<span class="mxinfo " id="T3:U234"><span class="mxinfo " id="T3:U235"><span class="var type1" id="S34T13U450">meanVel</span>(<span class="var type1" id="S50T3U451">j</span>)</span>^3</span></span>)</span> + <span class="mxinfo " id="T30:U238">kron(<span class="mxinfo " id="T30:U239"><span class="var type1" id="S39T19U456">Eye</span>(<span class="mxinfo " id="T31:U241"><span class="mxinfo " id="T3:U242">1</span>:<span class="mxinfo " id="T3:U243"><span class="var type1" id="S38T1U460">N</span>(<span class="var type1" id="S50T3U461">j</span>)</span></span>,<span class="mxinfo " id="T31:U246"><span class="mxinfo " id="T3:U247">1</span>:<span class="mxinfo " id="T3:U248"><span class="var type1" id="S38T1U465">N</span>(<span class="var type1" id="S50T3U466">j</span>)</span></span>)</span>,<span class="mxinfo " id="T8:U251"><span class="var type1" id="S21T8U468">Qt</span>*<span class="mxinfo " id="T3:U253">eps</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">    <span class="mxinfo " id="T30:U254"><span class="var type1" id="S54T30U473">Hj2</span> = <span class="mxinfo " id="T30:U256">kron(<span class="mxinfo " id="T30:U257"><span class="var type1" id="S39T19U477">Eye</span>(<span class="mxinfo " id="T31:U259"><span class="mxinfo " id="T3:U260">1</span>:<span class="mxinfo " id="T3:U261"><span class="var type1" id="S38T1U481">N</span>(<span class="var type1" id="S50T3U482">j</span>)</span></span>,<span class="mxinfo " id="T31:U264"><span class="mxinfo " id="T3:U265">1</span>:<span class="mxinfo " id="T3:U266"><span class="var type1" id="S38T1U486">N</span>(<span class="var type1" id="S50T3U487">j</span>)</span></span>)</span>,<span class="mxinfo " id="T3:U269"><span class="mxinfo " id="T3:U270"><span class="mxinfo " id="T3:U271">2</span>*<span class="mxinfo " id="T3:U272"><span class="var type1" id="S26T5U492">w</span>(<span class="mxinfo " id="T15:U274">2</span>)</span></span>*<span class="mxinfo " id="T3:U275"><span class="mxinfo " id="T3:U276"><span class="var type1" id="S34T13U496">meanVel</span>(<span class="var type1" id="S50T3U497">j</span>)</span>^5</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    <span class="mxinfo " id="T30:U279"><span class="var type1" id="S55T30U501">Hj3</span> = <span class="mxinfo " id="T30:U281">kron(<span class="mxinfo " id="T30:U282"><span class="var type1" id="S39T19U505">Eye</span>(<span class="mxinfo " id="T31:U284"><span class="mxinfo " id="T3:U285">1</span>:<span class="mxinfo " id="T3:U286"><span class="var type1" id="S38T1U509">N</span>(<span class="var type1" id="S50T3U510">j</span>)</span></span>,<span class="mxinfo " id="T31:U289"><span class="mxinfo " id="T3:U290">1</span>:<span class="mxinfo " id="T3:U291"><span class="var type1" id="S38T1U514">N</span>(<span class="var type1" id="S50T3U515">j</span>)</span></span>)</span>,<span class="mxinfo " id="T3:U294"><span class="mxinfo " id="T3:U295"><span class="mxinfo " id="T3:U296">2</span>*<span class="mxinfo " id="T3:U297"><span class="var type1" id="S26T5U520">w</span>(<span class="mxinfo " id="T15:U299">3</span>)</span></span>*<span class="mxinfo " id="T3:U300"><span class="mxinfo " id="T3:U301"><span class="var type1" id="S34T13U524">meanVel</span>(<span class="var type1" id="S50T3U525">j</span>)</span>^7</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">    <span class="mxinfo " id="T22:U304"><span class="var type1" id="S44T22U529">Hm</span> = <span class="mxinfo " id="T30:U306">blkdiag(<span class="var type1" id="S44T22U532">Hm</span>,<span class="var type1" id="S51T30U533">Hj1</span>,<span class="var type1" id="S54T30U534">Hj2</span>,<span class="var type1" id="S55T30U535">Hj3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">    <span class="mxinfo " id="T24:U311"><span class="var type1" id="S45T24U538">f</span> = <span class="mxinfo " id="T17:U313">[<span class="var type1" id="S45T24U541">f</span>; <span class="mxinfo " id="T17:U315">kron(<span class="mxinfo " id="T17:U316"><span class="var type1" id="S42T21U546">Ones</span>(<span class="mxinfo " id="T31:U318"><span class="mxinfo " id="T3:U319">1</span>:<span class="mxinfo " id="T3:U320"><span class="var type1" id="S38T1U550">N</span>(<span class="var type1" id="S50T3U551">j</span>)</span></span>,<span class="mxinfo " id="T15:U323">1</span>)</span>,<span class="mxinfo " id="T12:U324"><span class="mxinfo " id="T3:U325"><span class="mxinfo " id="T3:U326"><span class="mxinfo " id="T3:U327"><span class="mxinfo " id="T3:U328">-2*1</span>/<span class="mxinfo " id="T3:U329"><span class="var type1" id="S33T13U562">refVel</span>(<span class="var type1" id="S50T3U563">j</span>)</span></span>*<span class="mxinfo " id="T3:U332"><span class="var type1" id="S26T5U565">w</span>(<span class="mxinfo " id="T3:U334">1</span>)</span></span>*<span class="mxinfo " id="T3:U335"><span class="mxinfo " id="T3:U336"><span class="var type1" id="S34T13U569">meanVel</span>(<span class="var type1" id="S50T3U570">j</span>)</span>^3</span></span>*<span class="var type1" id="S19T12U572">C</span></span>)</span>; <span class="mxinfo " id="T17:U340"><span class="var type1" id="S41T20U575">Zeros</span>(<span class="mxinfo " id="T31:U342"><span class="mxinfo " id="T3:U343">1</span>:<span class="mxinfo " id="T3:U344"><span class="mxinfo " id="T3:U345">2</span>*<span class="mxinfo " id="T3:U346"><span class="var type1" id="S38T1U581">N</span>(<span class="var type1" id="S50T3U582">j</span>)</span></span></span>,<span class="mxinfo " id="T3:U349">1</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"><span class="comment">% % Equality contraints</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">         </span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">    <span class="mxinfo " id="T30:U350"><span class="var type1" id="S57T30U586">Ha</span> = <span class="mxinfo " id="T30:U352">[<span class="mxinfo " id="T32:U353"><span class="var type1" id="S41T20U590">Zeros</span>(<span class="mxinfo " id="T33:U355">1:2</span>,<span class="mxinfo " id="T31:U356"><span class="mxinfo " id="T3:U357">1</span>:<span class="mxinfo " id="T3:U358"><span class="mxinfo " id="T3:U359">2</span>*<span class="mxinfo " id="T3:U360"><span class="var type1" id="S38T1U599">N</span>(<span class="var type1" id="S50T3U600">j</span>)</span></span></span>)</span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">          <span class="mxinfo " id="T30:U363"><span class="mxinfo " id="T30:U364">kron(<span class="mxinfo " id="T30:U365"><span class="var type1" id="S39T19U605">Eye</span>(<span class="mxinfo " id="T31:U367"><span class="mxinfo " id="T3:U368">1</span>:<span class="mxinfo " id="T3:U369"><span class="mxinfo " id="T3:U370"><span class="var type1" id="S38T1U610">N</span>(<span class="var type1" id="S50T3U611">j</span>)</span>-<span class="mxinfo " id="T3:U373">1</span></span></span>,<span class="mxinfo " id="T31:U374"><span class="mxinfo " id="T3:U375">1</span>:<span class="mxinfo " id="T3:U376"><span class="mxinfo " id="T3:U377"><span class="var type1" id="S38T1U617">N</span>(<span class="var type1" id="S50T3U618">j</span>)</span>-<span class="mxinfo " id="T3:U380">1</span></span></span>)</span>,<span class="var type1" id="S17T8U620">A</span>)</span> <span class="mxinfo " id="T34:U382"><span class="var type1" id="S41T20U622">Zeros</span>(<span class="mxinfo " id="T31:U384"><span class="mxinfo " id="T3:U385">1</span>:<span class="mxinfo " id="T3:U386">(<span class="mxinfo " id="T3:U387"><span class="mxinfo " id="T3:U388"><span class="var type1" id="S38T1U629">N</span>(<span class="var type1" id="S50T3U630">j</span>)</span>-<span class="mxinfo " id="T3:U391">1</span></span>)*<span class="mxinfo " id="T3:U392">2</span></span></span>,<span class="mxinfo " id="T10:U393"><span class="mxinfo " id="T3:U394">1</span>:<span class="mxinfo " id="T3:U395">2</span></span>)</span></span>]</span></span>; <span class="comment">% multiply x(k) with A</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">    <span class="mxinfo " id="T30:U396"><span class="var type1" id="S58T30U638">Huk</span> = <span class="mxinfo " id="T30:U398">[<span class="mxinfo " id="T35:U399"><span class="var type1" id="S41T20U642">Zeros</span>(<span class="mxinfo " id="T3:U401">1</span>,<span class="mxinfo " id="T31:U402"><span class="mxinfo " id="T3:U403">1</span>:<span class="mxinfo " id="T3:U404"><span class="var type1" id="S38T1U647">N</span>(<span class="var type1" id="S50T3U648">j</span>)</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">           <span class="mxinfo " id="T30:U407"><span class="mxinfo " id="T30:U408"><span class="var type1" id="S39T19U651">Eye</span>(<span class="mxinfo " id="T31:U410"><span class="mxinfo " id="T3:U411">1</span>:<span class="mxinfo " id="T3:U412"><span class="mxinfo " id="T3:U413"><span class="var type1" id="S38T1U656">N</span>(<span class="var type1" id="S50T3U657">j</span>)</span>-<span class="mxinfo " id="T3:U416">1</span></span></span>,<span class="mxinfo " id="T31:U417"><span class="mxinfo " id="T3:U418">1</span>:<span class="mxinfo " id="T3:U419"><span class="mxinfo " id="T3:U420"><span class="var type1" id="S38T1U663">N</span>(<span class="var type1" id="S50T3U664">j</span>)</span>-<span class="mxinfo " id="T3:U423">1</span></span></span>)</span> <span class="mxinfo " id="T17:U424"><span class="var type1" id="S41T20U667">Zeros</span>(<span class="mxinfo " id="T31:U426"><span class="mxinfo " id="T3:U427">1</span>:<span class="mxinfo " id="T3:U428"><span class="mxinfo " id="T3:U429"><span class="var type1" id="S38T1U672">N</span>(<span class="var type1" id="S50T3U673">j</span>)</span>-<span class="mxinfo " id="T3:U432">1</span></span></span>,<span class="mxinfo " id="T3:U433">1</span>)</span></span>]</span></span>;     <span class="comment">% select all u(k)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">    <span class="mxinfo " id="T30:U434"><span class="var type1" id="S59T30U678">Hukp1</span> = <span class="mxinfo " id="T30:U436"><span class="var type1" id="S39T19U680">Eye</span>(<span class="mxinfo " id="T31:U438"><span class="mxinfo " id="T3:U439">1</span>:<span class="mxinfo " id="T3:U440"><span class="var type1" id="S38T1U684">N</span>(<span class="var type1" id="S50T3U685">j</span>)</span></span>,<span class="mxinfo " id="T31:U443"><span class="mxinfo " id="T3:U444">1</span>:<span class="mxinfo " id="T3:U445"><span class="var type1" id="S38T1U689">N</span>(<span class="var type1" id="S50T3U690">j</span>)</span></span>)</span></span>; <span class="comment">% select all u(k+1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">    <span class="mxinfo " id="T30:U448"><span class="var type1" id="S60T30U693">Aeq_car</span> = <span class="mxinfo " id="T30:U450">[<span class="mxinfo " id="T30:U451"><span class="mxinfo " id="T30:U452"><span class="var type1" id="S57T30U697">Ha</span>-<span class="mxinfo " id="T30:U454"><span class="var type1" id="S39T19U699">Eye</span>(<span class="mxinfo " id="T31:U456"><span class="mxinfo " id="T3:U457">1</span>:<span class="mxinfo " id="T3:U458"><span class="mxinfo " id="T3:U459">2</span>*<span class="mxinfo " id="T3:U460"><span class="var type1" id="S38T1U705">N</span>(<span class="var type1" id="S50T3U706">j</span>)</span></span></span>,<span class="mxinfo " id="T31:U463"><span class="mxinfo " id="T3:U464">1</span>:<span class="mxinfo " id="T3:U465"><span class="mxinfo " id="T3:U466">2</span>*<span class="mxinfo " id="T3:U467"><span class="var type1" id="S38T1U712">N</span>(<span class="var type1" id="S50T3U713">j</span>)</span></span></span>)</span></span>, <span class="mxinfo " id="T30:U470">kron(<span class="mxinfo " id="T30:U471"><span class="var type1" id="S39T19U717">Eye</span>(<span class="mxinfo " id="T31:U473"><span class="mxinfo " id="T3:U474">1</span>:<span class="mxinfo " id="T3:U475"><span class="var type1" id="S38T1U721">N</span>(<span class="var type1" id="S50T3U722">j</span>)</span></span>,<span class="mxinfo " id="T31:U478"><span class="mxinfo " id="T3:U479">1</span>:<span class="mxinfo " id="T3:U480"><span class="var type1" id="S38T1U726">N</span>(<span class="var type1" id="S50T3U727">j</span>)</span></span>)</span>,<span class="var type1" id="S18T12U728">B</span>)</span>, <span class="mxinfo " id="T30:U484"><span class="var type1" id="S41T20U730">Zeros</span>(<span class="mxinfo " id="T31:U486"><span class="mxinfo " id="T3:U487">1</span>:<span class="mxinfo " id="T3:U488"><span class="mxinfo " id="T3:U489">2</span>*<span class="mxinfo " id="T3:U490"><span class="var type1" id="S38T1U736">N</span>(<span class="var type1" id="S50T3U737">j</span>)</span></span></span>,<span class="mxinfo " id="T31:U493"><span class="mxinfo " id="T3:U494">1</span>:<span class="mxinfo " id="T3:U495"><span class="var type1" id="S38T1U741">N</span>(<span class="var type1" id="S50T3U742">j</span>)</span></span>)</span></span>; <span class="comment">% A*x(k)-I(2)*x(k+1)+B*u(k)=0 </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">               <span class="mxinfo " id="T30:U498"><span class="mxinfo " id="T30:U499"><span class="var type1" id="S41T20U745">Zeros</span>(<span class="mxinfo " id="T31:U501"><span class="mxinfo " id="T3:U502">1</span>:<span class="mxinfo " id="T3:U503"><span class="var type1" id="S38T1U749">N</span>(<span class="var type1" id="S50T3U750">j</span>)</span></span>,<span class="mxinfo " id="T31:U506"><span class="mxinfo " id="T3:U507">1</span>:<span class="mxinfo " id="T3:U508"><span class="mxinfo " id="T3:U509">2</span>*<span class="mxinfo " id="T3:U510"><span class="var type1" id="S38T1U756">N</span>(<span class="var type1" id="S50T3U757">j</span>)</span></span></span>)</span>, (<span class="mxinfo " id="T30:U513"><span class="var type1" id="S59T30U760">Hukp1</span>-<span class="var type1" id="S58T30U761">Huk</span></span>), <span class="mxinfo " id="T30:U516">-<span class="mxinfo " id="T30:U517">blkdiag(<span class="mxinfo " id="T3:U518"><span class="mxinfo " id="T3:U519"><span class="var type1" id="S14T1U767">vx</span>(<span class="var type1" id="S50T3U768">j</span>)</span>*<span class="var type1" id="S28T3U769">T</span></span>,<span class="mxinfo " id="T30:U523"><span class="var type1" id="S24T3U771">ds</span>*<span class="mxinfo " id="T30:U525"><span class="var type1" id="S39T19U773">Eye</span>(<span class="mxinfo " id="T31:U527"><span class="mxinfo " id="T3:U528">1</span>:<span class="mxinfo " id="T3:U529"><span class="mxinfo " id="T3:U530"><span class="var type1" id="S38T1U778">N</span>(<span class="var type1" id="S50T3U779">j</span>)</span>-<span class="mxinfo " id="T3:U533">1</span></span></span>,<span class="mxinfo " id="T31:U534"><span class="mxinfo " id="T3:U535">1</span>:<span class="mxinfo " id="T3:U536"><span class="mxinfo " id="T3:U537"><span class="var type1" id="S38T1U785">N</span>(<span class="var type1" id="S50T3U786">j</span>)</span>-<span class="mxinfo " id="T3:U540">1</span></span></span>)</span></span>)</span></span></span>]</span></span>; <span class="comment">% u'(k)*ds = u(k+1) - u(k))</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">               </span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">    <span class="mxinfo " id="T17:U541"><span class="var type1" id="S61T17U790">beq_car</span> = <span class="mxinfo " id="T17:U543">[(<span class="mxinfo " id="T12:U544"><span class="mxinfo " id="T8:U545">-<span class="var type1" id="S17T8U796">A</span></span>*<span class="mxinfo " id="T12:U547"><span class="var type1" id="S35T14U798">xk</span>(<span class="mxinfo " id="T33:U549">:</span>,<span class="var type1" id="S50T3U800">j</span>)</span></span>); <span class="mxinfo " id="T17:U551"><span class="var type1" id="S41T20U803">Zeros</span>(<span class="mxinfo " id="T31:U553"><span class="mxinfo " id="T3:U554">1</span>:<span class="mxinfo " id="T3:U555">(<span class="mxinfo " id="T3:U556"><span class="mxinfo " id="T3:U557"><span class="var type1" id="S38T1U810">N</span>(<span class="var type1" id="S50T3U811">j</span>)</span>-<span class="mxinfo " id="T3:U560">1</span></span>)*<span class="mxinfo " id="T3:U561">2</span></span></span>,<span class="mxinfo " id="T3:U562">1</span>)</span>; <span class="mxinfo " id="T3:U563"><span class="var type1" id="S36T13U817">uk</span>(<span class="var type1" id="S50T3U818">j</span>)</span>; <span class="mxinfo " id="T17:U566"><span class="var type1" id="S41T20U821">Zeros</span>(<span class="mxinfo " id="T31:U568"><span class="mxinfo " id="T3:U569">1</span>:(<span class="mxinfo " id="T3:U570"><span class="mxinfo " id="T3:U571"><span class="var type1" id="S38T1U827">N</span>(<span class="var type1" id="S50T3U828">j</span>)</span>-<span class="mxinfo " id="T3:U574">1</span></span>)</span>,<span class="mxinfo " id="T3:U575">1</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">    <span class="mxinfo " id="T25:U576"><span class="var type1" id="S46T25U833">Aeq</span> = <span class="mxinfo " id="T30:U578">blkdiag(<span class="var type1" id="S46T25U836">Aeq</span>,<span class="var type1" id="S60T30U837">Aeq_car</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">    <span class="mxinfo " id="T26:U581"><span class="var type1" id="S47T26U840">beq</span> = <span class="mxinfo " id="T17:U583">[<span class="var type1" id="S47T26U843">beq</span>;<span class="var type1" id="S61T17U845">beq_car</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line">      </span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="comment">% % Inequality Constraints</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">    <span class="mxinfo " id="T30:U586"><span class="var type1" id="S62T30U848">Ain_car</span> = <span class="mxinfo " id="T30:U588">[<span class="mxinfo " id="T30:U589"><span class="mxinfo " id="T30:U590">kron(<span class="mxinfo " id="T30:U591"><span class="var type1" id="S39T19U854">Eye</span>(<span class="mxinfo " id="T31:U593"><span class="mxinfo " id="T3:U594">1</span>:<span class="mxinfo " id="T3:U595"><span class="var type1" id="S38T1U858">N</span>(<span class="var type1" id="S50T3U859">j</span>)</span></span>,<span class="mxinfo " id="T31:U598"><span class="mxinfo " id="T3:U599">1</span>:<span class="mxinfo " id="T3:U600"><span class="var type1" id="S38T1U863">N</span>(<span class="var type1" id="S50T3U864">j</span>)</span></span>)</span>,<span class="mxinfo " id="T10:U603">-<span class="mxinfo " id="T10:U604"><span class="var type1" id="S19T12U867">C</span>'</span></span>)</span>, <span class="mxinfo " id="T30:U606"><span class="var type1" id="S41T20U869">Zeros</span>(<span class="mxinfo " id="T31:U608"><span class="mxinfo " id="T3:U609">1</span>:<span class="mxinfo " id="T3:U610"><span class="var type1" id="S38T1U873">N</span>(<span class="var type1" id="S50T3U874">j</span>)</span></span>,<span class="mxinfo " id="T31:U613"><span class="mxinfo " id="T3:U614">1</span>:<span class="mxinfo " id="T3:U615"><span class="mxinfo " id="T3:U616">2</span>*<span class="mxinfo " id="T3:U617"><span class="var type1" id="S38T1U880">N</span>(<span class="var type1" id="S50T3U881">j</span>)</span></span></span>)</span></span>;  <span class="comment">% -1/vx &lt;= -1/vmax                   1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">               <span class="mxinfo " id="T30:U620"><span class="mxinfo " id="T30:U621">kron(<span class="mxinfo " id="T30:U622"><span class="var type1" id="S39T19U886">Eye</span>(<span class="mxinfo " id="T31:U624"><span class="mxinfo " id="T3:U625">1</span>:<span class="mxinfo " id="T3:U626"><span class="var type1" id="S38T1U890">N</span>(<span class="var type1" id="S50T3U891">j</span>)</span></span>,<span class="mxinfo " id="T31:U629"><span class="mxinfo " id="T3:U630">1</span>:<span class="mxinfo " id="T3:U631"><span class="var type1" id="S38T1U895">N</span>(<span class="var type1" id="S50T3U896">j</span>)</span></span>)</span>,<span class="mxinfo " id="T10:U634"><span class="var type1" id="S19T12U898">C</span>'</span>)</span>, <span class="mxinfo " id="T30:U636"><span class="var type1" id="S41T20U900">Zeros</span>(<span class="mxinfo " id="T31:U638"><span class="mxinfo " id="T3:U639">1</span>:<span class="mxinfo " id="T3:U640"><span class="var type1" id="S38T1U904">N</span>(<span class="var type1" id="S50T3U905">j</span>)</span></span>,<span class="mxinfo " id="T31:U643"><span class="mxinfo " id="T3:U644">1</span>:<span class="mxinfo " id="T3:U645"><span class="mxinfo " id="T3:U646">2</span>*<span class="mxinfo " id="T3:U647"><span class="var type1" id="S38T1U911">N</span>(<span class="var type1" id="S50T3U912">j</span>)</span></span></span>)</span></span>; <span class="comment">% 1/vx &lt;= 1/vmin                 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">               <span class="mxinfo " id="T30:U650"><span class="mxinfo " id="T30:U651">kron(<span class="mxinfo " id="T30:U652"><span class="var type1" id="S39T19U917">Eye</span>(<span class="mxinfo " id="T31:U654"><span class="mxinfo " id="T3:U655">1</span>:<span class="mxinfo " id="T3:U656"><span class="var type1" id="S38T1U921">N</span>(<span class="var type1" id="S50T3U922">j</span>)</span></span>,<span class="mxinfo " id="T31:U659"><span class="mxinfo " id="T3:U660">1</span>:<span class="mxinfo " id="T3:U661"><span class="var type1" id="S38T1U926">N</span>(<span class="var type1" id="S50T3U927">j</span>)</span></span>)</span>,<span class="mxinfo " id="T10:U664"><span class="mxinfo " id="T3:U665"><span class="mxinfo " id="T3:U666"><span class="mxinfo " id="T3:U667">-<span class="mxinfo " id="T3:U668">3</span></span>*<span class="var type1" id="S29T3U933">amax</span></span>*<span class="mxinfo " id="T3:U670"><span class="mxinfo " id="T3:U671"><span class="var type1" id="S14T1U936">vx</span>(<span class="var type1" id="S50T3U937">j</span>)</span>^2</span></span>*<span class="mxinfo " id="T10:U674"><span class="var type1" id="S19T12U940">C</span>'</span></span>)</span>, <span class="mxinfo " id="T30:U676">-<span class="mxinfo " id="T30:U677"><span class="var type1" id="S39T19U943">Eye</span>(<span class="mxinfo " id="T31:U679"><span class="mxinfo " id="T3:U680">1</span>:<span class="mxinfo " id="T3:U681"><span class="var type1" id="S38T1U947">N</span>(<span class="var type1" id="S50T3U948">j</span>)</span></span>,<span class="mxinfo " id="T31:U684"><span class="mxinfo " id="T3:U685">1</span>:<span class="mxinfo " id="T3:U686"><span class="var type1" id="S38T1U952">N</span>(<span class="var type1" id="S50T3U953">j</span>)</span></span>)</span></span>, <span class="mxinfo " id="T30:U689"><span class="var type1" id="S41T20U955">Zeros</span>(<span class="mxinfo " id="T31:U691"><span class="mxinfo " id="T3:U692">1</span>:<span class="mxinfo " id="T3:U693"><span class="var type1" id="S38T1U959">N</span>(<span class="var type1" id="S50T3U960">j</span>)</span></span>,<span class="mxinfo " id="T31:U696"><span class="mxinfo " id="T3:U697">1</span>:<span class="mxinfo " id="T3:U698"><span class="var type1" id="S38T1U964">N</span>(<span class="var type1" id="S50T3U965">j</span>)</span></span>)</span></span>;  <span class="comment">% -u &lt;= -umin     3)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">               <span class="mxinfo " id="T30:U701"><span class="mxinfo " id="T30:U702">kron(<span class="mxinfo " id="T30:U703"><span class="var type1" id="S39T19U970">Eye</span>(<span class="mxinfo " id="T31:U705"><span class="mxinfo " id="T3:U706">1</span>:<span class="mxinfo " id="T3:U707"><span class="var type1" id="S38T1U974">N</span>(<span class="var type1" id="S50T3U975">j</span>)</span></span>,<span class="mxinfo " id="T31:U710"><span class="mxinfo " id="T3:U711">1</span>:<span class="mxinfo " id="T3:U712"><span class="var type1" id="S38T1U979">N</span>(<span class="var type1" id="S50T3U980">j</span>)</span></span>)</span>,<span class="mxinfo " id="T10:U715"><span class="mxinfo " id="T3:U716"><span class="mxinfo " id="T3:U717"><span class="mxinfo " id="T3:U718">3</span>*<span class="var type1" id="S30T3U985">amin</span></span>*<span class="mxinfo " id="T3:U720"><span class="mxinfo " id="T3:U721"><span class="var type1" id="S14T1U988">vx</span>(<span class="var type1" id="S50T3U989">j</span>)</span>^2</span></span>*<span class="mxinfo " id="T10:U724"><span class="var type1" id="S19T12U992">C</span>'</span></span>)</span>, <span class="mxinfo " id="T30:U726"><span class="var type1" id="S39T19U994">Eye</span>(<span class="mxinfo " id="T31:U728"><span class="mxinfo " id="T3:U729">1</span>:<span class="mxinfo " id="T3:U730"><span class="var type1" id="S38T1U998">N</span>(<span class="var type1" id="S50T3U999">j</span>)</span></span>,<span class="mxinfo " id="T31:U733"><span class="mxinfo " id="T3:U734">1</span>:<span class="mxinfo " id="T3:U735"><span class="var type1" id="S38T1U1003">N</span>(<span class="var type1" id="S50T3U1004">j</span>)</span></span>)</span>, <span class="mxinfo " id="T30:U738"><span class="var type1" id="S41T20U1006">Zeros</span>(<span class="mxinfo " id="T31:U740"><span class="mxinfo " id="T3:U741">1</span>:<span class="mxinfo " id="T3:U742"><span class="var type1" id="S38T1U1010">N</span>(<span class="var type1" id="S50T3U1011">j</span>)</span></span>,<span class="mxinfo " id="T31:U745"><span class="mxinfo " id="T3:U746">1</span>:<span class="mxinfo " id="T3:U747"><span class="var type1" id="S38T1U1015">N</span>(<span class="var type1" id="S50T3U1016">j</span>)</span></span>)</span></span>]</span></span>; <span class="comment">% u &lt;= umax 4)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">           </span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">    <span class="mxinfo " id="T17:U750"><span class="var type1" id="S63T17U1019">bin_car</span> = <span class="mxinfo " id="T17:U752">[<span class="mxinfo " id="T17:U753"><span class="mxinfo " id="T17:U754"><span class="var type1" id="S42T21U1024">Ones</span>(<span class="mxinfo " id="T31:U756"><span class="mxinfo " id="T3:U757">1</span>:<span class="mxinfo " id="T3:U758"><span class="var type1" id="S38T1U1028">N</span>(<span class="var type1" id="S50T3U1029">j</span>)</span></span>,<span class="mxinfo " id="T3:U761">1</span>)</span>.*(<span class="mxinfo " id="T3:U762"><span class="mxinfo " id="T3:U763">-1</span>/<span class="var type1" id="S31T3U1035">vmax</span></span>)</span>;             <span class="comment">% 1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">               <span class="mxinfo " id="T17:U765"><span class="mxinfo " id="T17:U766"><span class="var type1" id="S42T21U1039">Ones</span>(<span class="mxinfo " id="T31:U768"><span class="mxinfo " id="T3:U769">1</span>:<span class="mxinfo " id="T3:U770"><span class="var type1" id="S38T1U1043">N</span>(<span class="var type1" id="S50T3U1044">j</span>)</span></span>,<span class="mxinfo " id="T3:U773">1</span>)</span>.*(<span class="mxinfo " id="T3:U774"><span class="mxinfo " id="T3:U775">1</span>/<span class="var type1" id="S32T3U1049">vmin</span></span>)</span>;          <span class="comment">% 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">               <span class="mxinfo " id="T17:U777"><span class="mxinfo " id="T17:U778"><span class="var type1" id="S42T21U1053">Ones</span>(<span class="mxinfo " id="T31:U780"><span class="mxinfo " id="T3:U781">1</span>:<span class="mxinfo " id="T3:U782"><span class="var type1" id="S38T1U1057">N</span>(<span class="var type1" id="S50T3U1058">j</span>)</span></span>,<span class="mxinfo " id="T3:U785">1</span>)</span>.*(<span class="mxinfo " id="T3:U786"><span class="mxinfo " id="T3:U787"><span class="mxinfo " id="T3:U788">-<span class="mxinfo " id="T3:U789">2</span></span>*<span class="var type1" id="S29T3U1065">amax</span></span>/<span class="mxinfo " id="T3:U791"><span class="mxinfo " id="T3:U792"><span class="var type1" id="S14T1U1068">vx</span>(<span class="var type1" id="S50T3U1069">j</span>)</span>^3</span></span>)</span>;   <span class="comment">% 3)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">               <span class="mxinfo " id="T17:U795"><span class="mxinfo " id="T17:U796"><span class="var type1" id="S42T21U1074">Ones</span>(<span class="mxinfo " id="T31:U798"><span class="mxinfo " id="T3:U799">1</span>:<span class="mxinfo " id="T3:U800"><span class="var type1" id="S38T1U1078">N</span>(<span class="var type1" id="S50T3U1079">j</span>)</span></span>,<span class="mxinfo " id="T3:U803">1</span>)</span>.*(<span class="mxinfo " id="T3:U804"><span class="mxinfo " id="T3:U805"><span class="mxinfo " id="T3:U806">2</span>*<span class="var type1" id="S30T3U1085">amin</span></span>/<span class="mxinfo " id="T3:U808"><span class="mxinfo " id="T3:U809"><span class="var type1" id="S14T1U1088">vx</span>(<span class="var type1" id="S50T3U1089">j</span>)</span>^3</span></span>)</span>]</span></span>;  <span class="comment">% 4)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">    <span class="mxinfo " id="T27:U812"><span class="var type1" id="S48T27U1093">Ain</span> = <span class="mxinfo " id="T30:U814">blkdiag(<span class="var type1" id="S48T27U1096">Ain</span>,<span class="var type1" id="S62T30U1097">Ain_car</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">    <span class="mxinfo " id="T28:U817"><span class="var type1" id="S49T28U1100">bin</span> = <span class="mxinfo " id="T17:U819">[<span class="var type1" id="S49T28U1103">bin</span>;<span class="var type1" id="S63T17U1105">bin_car</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    <span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line"><span class="comment">% % Cronologic crossing order Car 1-&gt; Car 2 -&gt; Car 3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line"><span class="comment">% % -------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line"><span class="comment">% % index for cars inside control region</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line"><span class="mxinfo " id="T17:U822"><span class="var type1" id="S64T17U1108">ind</span> = <span class="mxinfo " id="T17:U824">find(<span class="mxinfo " id="T18:U825"><span class="mxinfo " id="T18:U826"><span class="var type1" id="S11T1U1113">dist2Int</span>&lt; <span class="var type1" id="S22T3U1114">contR</span></span> &amp;  <span class="mxinfo " id="T18:U829"><span class="var type1" id="S11T1U1116">dist2Int</span> &gt; <span class="mxinfo " id="T3:U831">-(<span class="mxinfo " id="T3:U832"><span class="var type1" id="S22T3U1120">contR</span>+<span class="var type1" id="S23T3U1121">critZ</span></span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line"><span class="mxinfo " id="T3:U835"><span class="var type1" id="S66T3U1124">leni</span> = <span class="mxinfo " id="T3:U837">length(<span class="var type1" id="S64T17U1127">ind</span>)</span></span>; <span class="comment">% number of cars inside the crontrol region</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line"><span class="mxinfo " id="T3:U839"><span class="var type1" id="S68T3U1130">ns</span> = <span class="mxinfo " id="T3:U841">0</span></span>; <span class="comment">% number of added slack variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line"><span class="keyword">if</span>  <span class="mxinfo " id="T29:U842"><span class="var type1" id="S66T3U1135">leni</span> &gt;= <span class="mxinfo " id="T3:U844">2</span></span> <span class="comment">% if 2 or more cars is in the control region</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S50T3U1139">j</span>=<span class="mxinfo " id="T17:U846"><span class="mxinfo " id="T3:U847">1</span>: <span class="mxinfo " id="T3:U848"><span class="mxinfo " id="T3:U849">length(<span class="var type1" id="S64T17U1145">ind</span>)</span>-<span class="mxinfo " id="T3:U851">1</span></span></span> <span class="comment">% itterate all vehicle pairs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">        <span class="mxinfo " id="T3:U852"><span class="var type1" id="S69T3U1149">leave</span> = (<span class="mxinfo " id="T3:U854"><span class="mxinfo " id="T3:U855"><span class="var type1" id="S11T1U1153">dist2Int</span>(<span class="mxinfo " id="T3:U857"><span class="var type1" id="S64T17U1155">ind</span>(<span class="var type1" id="S50T3U1156">j</span>)</span>)</span>+<span class="var type1" id="S23T3U1157">critZ</span></span>)</span>; <span class="comment">% index [m] for first car to leave</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">        <span class="mxinfo " id="T3:U861"><span class="var type1" id="S70T3U1160">enter</span> = (<span class="mxinfo " id="T3:U863"><span class="var type1" id="S11T1U1163">dist2Int</span>(<span class="mxinfo " id="T3:U865"><span class="var type1" id="S64T17U1165">ind</span>(<span class="mxinfo " id="T3:U867"><span class="var type1" id="S50T3U1167">j</span>+<span class="mxinfo " id="T3:U869">1</span></span>)</span>)</span>)</span>; <span class="comment">% index [m] for next car to enter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">        <span class="comment">% if the indexes is positive add a slack variable for the vehicle pair</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T29:U870"><span class="mxinfo " id="T3:U871">min(<span class="var type1" id="S69T3U1174">leave</span>,<span class="var type1" id="S70T3U1175">enter</span>)</span> &gt;= <span class="mxinfo " id="T3:U874">1</span></span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">            <span class="mxinfo " id="T3:U875"><span class="var type1" id="S68T3U1179">ns</span> = <span class="mxinfo " id="T3:U877"><span class="var type1" id="S68T3U1181">ns</span>+<span class="mxinfo " id="T3:U879">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">            <span class="mxinfo " id="T27:U880"><span class="var type1" id="S48T27U1185">Ain</span> = <span class="mxinfo " id="T30:U882">blkdiag(<span class="var type1" id="S48T27U1188">Ain</span>,zeros(3,1))</span></span>; <span class="comment">% Add three rows for slack constraint</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">            <span class="mxinfo " id="T28:U884"><span class="var type1" id="S49T28U1195">bin</span> = <span class="mxinfo " id="T17:U886">[<span class="var type1" id="S49T28U1198">bin</span>; <span class="mxinfo " id="T1:U888">zeros(<span class="mxinfo " id="T3:U889">3</span>,1)</span>]</span></span>; <span class="comment">% -||-</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">            <span class="mxinfo " id="T3:U890"><span class="mxinfo " id="T3:U891"><span class="var type1" id="S48T27U1207">Ain</span>(<span class="mxinfo " id="T3:U893"><span class="mxinfo " id="T3:U894">end</span>-<span class="mxinfo " id="T3:U895">2</span></span>,<span class="mxinfo " id="T3:U896"><span class="mxinfo " id="T3:U897"><span class="mxinfo " id="T3:U898"><span class="mxinfo " id="T3:U899">2</span>*<span class="var type1" id="S69T3U1216">leave</span></span>-<span class="mxinfo " id="T3:U901">1</span></span> + <span class="mxinfo " id="T3:U902"><span class="mxinfo " id="T3:U903">4</span>*<span class="mxinfo " id="T3:U904">sum(<span class="mxinfo " id="T17:U905"><span class="var type1" id="S38T1U1223">N</span>(<span class="mxinfo " id="T31:U907"><span class="mxinfo " id="T3:U908">1</span>:(<span class="mxinfo " id="T3:U909"><span class="mxinfo " id="T3:U910"><span class="var type1" id="S64T17U1229">ind</span>(<span class="var type1" id="S50T3U1230">j</span>)</span>-<span class="mxinfo " id="T3:U913">1</span></span>)</span>)</span>)</span></span></span>)</span> = <span class="mxinfo " id="T3:U914">-1</span></span>;  <span class="comment">% 1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">            <span class="mxinfo " id="T3:U915"><span class="mxinfo " id="T3:U916"><span class="var type1" id="S48T27U1237">Ain</span>(<span class="mxinfo " id="T3:U918"><span class="mxinfo " id="T3:U919">end</span>-<span class="mxinfo " id="T3:U920">2</span></span>,<span class="mxinfo " id="T3:U921"><span class="mxinfo " id="T3:U922"><span class="mxinfo " id="T3:U923"><span class="mxinfo " id="T3:U924">2</span>*<span class="var type1" id="S70T3U1246">enter</span></span>-<span class="mxinfo " id="T3:U926">1</span></span> + <span class="mxinfo " id="T3:U927"><span class="mxinfo " id="T3:U928">4</span>*<span class="mxinfo " id="T3:U929">sum(<span class="mxinfo " id="T17:U930"><span class="var type1" id="S38T1U1253">N</span>(<span class="mxinfo " id="T31:U932"><span class="mxinfo " id="T3:U933">1</span>:(<span class="mxinfo " id="T3:U934"><span class="mxinfo " id="T3:U935"><span class="var type1" id="S64T17U1259">ind</span>(<span class="mxinfo " id="T3:U937"><span class="var type1" id="S50T3U1261">j</span>+<span class="mxinfo " id="T3:U939">1</span></span>)</span>-<span class="mxinfo " id="T3:U940">1</span></span>)</span>)</span>)</span></span></span>)</span> = <span class="mxinfo " id="T3:U941">1</span></span>; <span class="comment">% 1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">            <span class="mxinfo " id="T3:U942"><span class="mxinfo " id="T3:U943"><span class="var type1" id="S48T27U1268">Ain</span>(<span class="mxinfo " id="T3:U945"><span class="mxinfo " id="T3:U946">end</span>-<span class="mxinfo " id="T3:U947">1</span></span>,<span class="mxinfo " id="T3:U948"><span class="mxinfo " id="T3:U949"><span class="mxinfo " id="T3:U950"><span class="mxinfo " id="T3:U951">2</span>*<span class="var type1" id="S69T3U1277">leave</span></span>-<span class="mxinfo " id="T3:U953">1</span></span> + <span class="mxinfo " id="T3:U954"><span class="mxinfo " id="T3:U955">4</span>*<span class="mxinfo " id="T3:U956">sum(<span class="mxinfo " id="T17:U957"><span class="var type1" id="S38T1U1284">N</span>(<span class="mxinfo " id="T31:U959"><span class="mxinfo " id="T3:U960">1</span>:(<span class="mxinfo " id="T3:U961"><span class="mxinfo " id="T3:U962"><span class="var type1" id="S64T17U1290">ind</span>(<span class="var type1" id="S50T3U1291">j</span>)</span>-<span class="mxinfo " id="T3:U965">1</span></span>)</span>)</span>)</span></span></span>)</span> = <span class="mxinfo " id="T3:U966">-1</span></span>;  <span class="comment">% 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">            <span class="mxinfo " id="T3:U967"><span class="mxinfo " id="T3:U968"><span class="var type1" id="S48T27U1298">Ain</span>(<span class="mxinfo " id="T3:U970"><span class="mxinfo " id="T3:U971">end</span>-<span class="mxinfo " id="T3:U972">1</span></span>,<span class="mxinfo " id="T3:U973"><span class="mxinfo " id="T3:U974"><span class="mxinfo " id="T3:U975"><span class="mxinfo " id="T3:U976">2</span>*<span class="var type1" id="S70T3U1307">enter</span></span>-<span class="mxinfo " id="T3:U978">1</span></span> + <span class="mxinfo " id="T3:U979"><span class="mxinfo " id="T3:U980">4</span>*<span class="mxinfo " id="T3:U981">sum(<span class="mxinfo " id="T17:U982"><span class="var type1" id="S38T1U1314">N</span>(<span class="mxinfo " id="T31:U984"><span class="mxinfo " id="T3:U985">1</span>:(<span class="mxinfo " id="T3:U986"><span class="mxinfo " id="T3:U987"><span class="var type1" id="S64T17U1320">ind</span>(<span class="mxinfo " id="T3:U989"><span class="var type1" id="S50T3U1322">j</span>+<span class="mxinfo " id="T3:U991">1</span></span>)</span>-<span class="mxinfo " id="T3:U992">1</span></span>)</span>)</span>)</span></span></span>)</span> = <span class="mxinfo " id="T3:U993">1</span></span>; <span class="comment">% 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">            <span class="mxinfo " id="T3:U994"><span class="mxinfo " id="T3:U995"><span class="var type1" id="S48T27U1329">Ain</span>(<span class="mxinfo " id="T3:U997"><span class="mxinfo " id="T3:U998">end</span>-<span class="mxinfo " id="T3:U999">1</span></span>,<span class="mxinfo " id="T3:U1000">end</span>)</span> = <span class="mxinfo " id="T3:U1001">-1</span></span>;                                  <span class="comment">% 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">            <span class="mxinfo " id="T3:U1002"><span class="mxinfo " id="T3:U1003"><span class="var type1" id="S49T28U1341">bin</span>(<span class="mxinfo " id="T3:U1005"><span class="mxinfo " id="T3:U1006">end</span>-<span class="mxinfo " id="T3:U1007">1</span></span>)</span> = <span class="mxinfo " id="T3:U1008">-<span class="var type1" id="S27T3U1347">tdiff</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">            <span class="mxinfo " id="T3:U1010"><span class="mxinfo " id="T3:U1011"><span class="var type1" id="S48T27U1351">Ain</span>(<span class="mxinfo " id="T3:U1013">end</span>,<span class="mxinfo " id="T3:U1014">end</span>)</span> = <span class="mxinfo " id="T3:U1015">-<span class="mxinfo " id="T3:U1016">1</span></span></span>;                                    <span class="comment">% 3)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">            <span class="comment">% 1) -t(car_2(enter)) + t(car_1(leave)) &lt;= 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">            <span class="comment">% 2) t(car_2(enter)) - t(car_1(leave)) - q &lt;= -tdiff</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">            <span class="comment">% 3) -q &lt;= 0  </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T29:U1017"><span class="var type1" id="S68T3U1361">ns</span> &gt; <span class="mxinfo " id="T3:U1019">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line">    <span class="mxinfo " id="T25:U1020"><span class="var type1" id="S46T25U1365">Aeq</span> = <span class="mxinfo " id="T30:U1022">[<span class="var type1" id="S46T25U1368">Aeq</span>, <span class="mxinfo " id="T30:U1024"><span class="var type1" id="S41T20U1370">Zeros</span>(<span class="mxinfo " id="T31:U1026"><span class="mxinfo " id="T3:U1027">1</span>:(<span class="mxinfo " id="T3:U1028"><span class="mxinfo " id="T3:U1029">sum(<span class="var type1" id="S38T1U1377">N</span>)</span>*<span class="mxinfo " id="T3:U1031">3</span></span>)</span>,<span class="mxinfo " id="T31:U1032"><span class="mxinfo " id="T3:U1033">1</span>:<span class="var type1" id="S68T3U1381">ns</span></span>)</span>]</span></span>; <span class="comment">% Add variable q for each slack variable</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line">    <span class="mxinfo " id="T22:U1035"><span class="var type1" id="S44T22U1384">Hm</span> = <span class="mxinfo " id="T30:U1037">blkdiag(<span class="var type1" id="S44T22U1387">Hm</span>,<span class="mxinfo " id="T30:U1039">kron(<span class="mxinfo " id="T30:U1040"><span class="var type1" id="S39T19U1391">Eye</span>(<span class="mxinfo " id="T31:U1042"><span class="mxinfo " id="T3:U1043">1</span>:<span class="var type1" id="S68T3U1394">ns</span></span>,<span class="mxinfo " id="T31:U1045"><span class="mxinfo " id="T3:U1046">1</span>:<span class="var type1" id="S68T3U1397">ns</span></span>)</span>,<span class="mxinfo " id="T3:U1048"><span class="mxinfo " id="T3:U1049">2</span>*<span class="mxinfo " id="T3:U1050"><span class="var type1" id="S26T5U1401">w</span>(<span class="mxinfo " id="T15:U1052">4</span>)</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line">    <span class="mxinfo " id="T24:U1053"><span class="var type1" id="S45T24U1405">f</span> = <span class="mxinfo " id="T17:U1055">[<span class="var type1" id="S45T24U1408">f</span>; <span class="mxinfo " id="T17:U1057"><span class="var type1" id="S41T20U1411">Zeros</span>(<span class="mxinfo " id="T31:U1059"><span class="mxinfo " id="T3:U1060">1</span>:<span class="var type1" id="S68T3U1414">ns</span></span>,<span class="mxinfo " id="T3:U1062">1</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line"><span class="comment">% % If any car is within the control region the MPC will optimize the path</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line"><span class="comment">% % for all cars within the controlling region.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T29:U1063">~<span class="mxinfo " id="T29:U1064">isempty(<span class="var type1" id="S44T22U1421">Hm</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">   <span class="mxinfo " id="T24:U1066"><span class="var type1" id="S75T24U1424">x</span> = <span class="mxinfo " id="T17:U1068">zeros(<span class="mxinfo " id="T3:U1069">size(<span class="var type1" id="S44T22U1429">Hm</span>,2)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">   <span class="mxinfo " id="T36:U1071">[<span class="var type1" id="S75T24U1435">x</span>,<span class="mxinfo " id="T3:U1073">~</span>,<span class="var type1" id="S4T3U1437">exflag</span>] = <span class="extrinsicFcn" id="F258N5:B1439">quadprog</span>(<span class="var type1" id="S44T22U1440">Hm</span>,<span class="var type1" id="S45T24U1441">f</span>,<span class="var type1" id="S48T27U1442">Ain</span>,<span class="var type1" id="S49T28U1443">bin</span>,<span class="var type1" id="S46T25U1444">Aeq</span>,<span class="var type1" id="S47T26U1445">beq</span>,<span class="mxinfo " id="T23:U1081">[]</span>,<span class="mxinfo " id="T23:U1082">[]</span>,<span class="mxinfo " id="T23:U1083">[]</span>)</span>; <span class="comment">%,options);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">   <span class="comment">% tic;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T29:U1084"><span class="var type1" id="S4T3U1455">exflag</span> == <span class="mxinfo " id="T3:U1086">-<span class="mxinfo " id="T3:U1087">2</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">        <span class="mxinfo " id="T36:U1088"><span class="autoExtrinsicFcn" id="F259N3:B1460">disp</span>(<span class="mxinfo " id="T37:U1089"><span class="string">'Error: exflag == 2 '</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line">    <span class="mxinfo " id="T2:U1090"><span class="var type1" id="S3T2U1464"><span class="message error" id="M4F1C">xvec</span></span></span> = <span class="mxinfo " id="T17:U1091">[<span class="var type1" id="S75T24U1467">x</span>; <span class="mxinfo " id="T17:U1093">zeros(<span class="mxinfo " id="T3:U1094"><span class="mxinfo " id="T3:U1095"><span class="mxinfo " id="T3:U1096"><span class="mxinfo " id="T3:U1097"><span class="mxinfo " id="T3:U1098">135</span>*<span class="mxinfo " id="T3:U1099">4</span></span>*<span class="mxinfo " id="T3:U1100">3</span></span>+<span class="mxinfo " id="T3:U1101">2</span></span>-<span class="mxinfo " id="T3:U1102">size(<span class="var type1" id="S75T24U1481">x</span>,1)</span></span>,1)</span>]</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S50T3U1486">j</span>=<span class="mxinfo " id="T1:U1105"><span class="mxinfo " id="T3:U1106">1</span>:<span class="var type1" id="S25T3U1489">numCars</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">        <span class="mxinfo " id="T3:U1108"><span class="var type1" id="S79T3U1492">prev</span> = <span class="mxinfo " id="T3:U1110"><span class="mxinfo " id="T3:U1111">4</span>*<span class="mxinfo " id="T3:U1112">sum(<span class="mxinfo " id="T17:U1113"><span class="var type1" id="S38T1U1498">N</span>(<span class="mxinfo " id="T31:U1115"><span class="mxinfo " id="T3:U1116">1</span>:<span class="mxinfo " id="T3:U1117"><span class="var type1" id="S50T3U1502">j</span>-<span class="mxinfo " id="T3:U1119">1</span></span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T29:U1120"><span class="mxinfo " id="T3:U1121"><span class="var type1" id="S38T1U1508">N</span>(<span class="var type1" id="S50T3U1509">j</span>)</span> &gt; <span class="mxinfo " id="T3:U1124">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line">            <span class="mxinfo " id="T3:U1125"><span class="mxinfo " id="T3:U1126"><span class="var type1" id="S2T1U1514">longAcc</span>(<span class="var type1" id="S50T3U1515">j</span>)</span> =  <span class="mxinfo " id="T3:U1129"><span class="mxinfo " id="T3:U1130">-<span class="mxinfo " id="T3:U1131"><span class="var type1" id="S75T24U1519">x</span>(<span class="mxinfo " id="T3:U1133"><span class="mxinfo " id="T3:U1134"><span class="mxinfo " id="T3:U1135"><span class="mxinfo " id="T3:U1136">2</span>*<span class="mxinfo " id="T3:U1137"><span class="var type1" id="S38T1U1525">N</span>(<span class="var type1" id="S50T3U1526">j</span>)</span></span>+<span class="mxinfo " id="T3:U1140">1</span></span> + <span class="var type1" id="S79T3U1528">prev</span></span>)</span></span>/ <span class="mxinfo " id="T3:U1142"><span class="mxinfo " id="T3:U1143"><span class="var type1" id="S75T24U1531">x</span>(<span class="mxinfo " id="T3:U1145"><span class="mxinfo " id="T3:U1146">2</span> + <span class="var type1" id="S79T3U1534">prev</span></span>)</span>^3</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line">            <span class="mxinfo " id="T3:U1148"><span class="mxinfo " id="T3:U1149"><span class="var type1" id="S2T1U1540">longAcc</span>(<span class="var type1" id="S50T3U1541">j</span>)</span> = <span class="mxinfo " id="T3:U1152">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S50T3U1546">j</span>=<span class="mxinfo " id="T1:U1154"><span class="mxinfo " id="T3:U1155">1</span>:<span class="var type1" id="S25T3U1549">numCars</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line">        <span class="mxinfo " id="T3:U1157"><span class="mxinfo " id="T3:U1158"><span class="var type1" id="S2T1U1553">longAcc</span>(<span class="var type1" id="S50T3U1554">j</span>)</span> = <span class="mxinfo " id="T3:U1161">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line"></span></span>
</pre>
